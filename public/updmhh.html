<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Nhập Danh Mục Hàng Hóa</title>
  <!-- PapaParse để đọc CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Handsontable -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.min.css">
  <script src="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { margin: 5px 0; }
  </style>
</head>
<body>

<h2>📦 Cập nhật Danh Mục Hàng Hóa từ Excel/CSV</h2>

<input type="file" id="fileInput" accept=".csv,.xlsx" />
<button onclick="loadCSV()">📂 Đọc dữ liệu từ file</button>
<button onclick="uploadToSupabase()">📤 Ghi vào Supabase</button>

<div id="hot" style="margin-top:20px;"></div>
<div id="preview" style="margin-top:20px;"></div>

<script>
  const SUPABASE_URL = 'https://rddjrmbyftlcvrgzlyby.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkZGpybWJ5ZnRsY3ZyZ3pseWJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NjU4MDQsImV4cCI6MjA2MjM0MTgwNH0.-0xtqxn6b9OBz4unTTvJ4klxizWhHa1iSuYGm7cOYTM';
  const TABLE_NAME = 'dmhanghoa';

  const columns = [
    { data: 'masp', type: 'text' },
    { data: 'tensp', type: 'text' },
    { data: 'dvt', type: 'text' },
    { data: 'chungloai', type: 'text' },
    { data: 'giale', type: 'numeric' },
    { data: 'giasi', type: 'numeric' },
    { data: 'mangan', type: 'text' },
    { data: 'nhomhang', type: 'text' },
    { data: 'mausac', type: 'text' },
    { data: 'gianhap', type: 'numeric' },
    { data: 'nhacc', type: 'text' },
    { data: 'quanlykichco', type: 'checkbox' },
    { data: 'nhapdau', type: 'date', dateFormat: 'YYYY-MM-DD', correctFormat: true },
    { data: 'ngaysua', type: 'date', dateFormat: 'YYYY-MM-DD', correctFormat: true }
  ];

  const hot = new Handsontable(document.getElementById('hot'), {
    data: Array(100).fill({}),
    columns,
    colHeaders: columns.map(col => col.data),
    rowHeaders: true,
    stretchH: 'all',
    height: 500,
    licenseKey: 'non-commercial-and-evaluation'
  });

  function loadCSV() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return alert('Vui lòng chọn file CSV.');

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: function (results) {
        const data = results.data;
        hot.loadData(data);
        console.log("🧪 Dòng đầu:", data[0]);
      }
    });
  }

  function isValidDate(d) {
    return !isNaN(Date.parse(d));
  }

  function cleanRow(row) {
    const validFields = {
      masp: "text",
      tensp: "text",
      dvt: "text",
      chungloai: "text",
      giale: "numeric",
      giasi: "numeric",
      mangan: "text",
      nhomhang: "text",
      mausac: "text",
      gianhap: "numeric",
      nhacc: "text",
      quanlykichco: "boolean",
      nhapdau: "date",
      ngaysua: "date"
    };

    const cleaned = {};
    for (const key in validFields) {
      if (!(key in row)) continue;
      const val = row[key];

      if (val === "" || val === null) {
        cleaned[key] = null;
      } else if (validFields[key] === "numeric") {
        cleaned[key] = isNaN(Number(val)) ? null : Number(val);
      } else if (validFields[key] === "boolean") {
        cleaned[key] = val.toString().toLowerCase() === "true" || val === "1";
      } else if (validFields[key] === "date") {
        cleaned[key] = isValidDate(val) ? val : null;
      } else {
        cleaned[key] = val;
      }
    }

    return cleaned;
  }

  async function uploadToSupabase() {
    const rawData = hot.getData();
    const headers = columns.map(col => col.data);

    const parsedData = rawData.map(row => {
      const obj = {};
      headers.forEach((h, i) => {
        obj[h] = row[i];
      });
      return obj;
    }).filter(row => row.masp && row.masp.toString().trim() !== "");

    if (parsedData.length === 0) return alert("Không có dòng hợp lệ để ghi.");

    const yes = confirm("Bạn có chắc muốn ghi dữ liệu này vào Supabase? (Sẽ ghi đè nếu mã sản phẩm trùng)");
    if (!yes) return;

    const batchSize = 1000;
    let countInsert = 0;
    let countUpdate = 0;
    let countError = 0;
    let errorList = [];

    for (let i = 0; i < parsedData.length; i += batchSize) {
      const batch = parsedData.slice(i, i + batchSize).map(cleanRow);

      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE_NAME}`, {
          method: "POST",
          headers: {
            apikey: SUPABASE_KEY,
            Authorization: `Bearer ${SUPABASE_KEY}`,
            "Content-Type": "application/json",
            Prefer: "resolution=merge-duplicates,return=representation"
          },
          body: JSON.stringify(batch)
        });

        const data = await res.json();
        if (!res.ok) {
          countError += batch.length;
          errorList.push(`❌ Lỗi batch từ dòng ${i + 1} đến ${i + batch.length}: ${JSON.stringify(data)}`);
        } else {
          for (const item of data) {
            if (item.updated_at || item.ngaysua) countUpdate++;
            else countInsert++;
          }
        }
      } catch (err) {
        countError += batch.length;
        errorList.push(`❌ Lỗi kết nối batch từ dòng ${i + 1} đến ${i + batch.length}`);
        console.error(err);
      }
    }

    const report = `
      <h3>📊 Kết quả ghi dữ liệu:</h3>
      <ul>
        <li>✅ Tổng: ${parsedData.length}</li>
        <li>🆕 Thêm mới: ${countInsert}</li>
        <li>♻️ Ghi đè: ${countUpdate}</li>
        <li>❌ Lỗi: ${countError}</li>
      </ul>
      ${countError > 0 ? `<details><summary>🔍 Xem chi tiết lỗi</summary><pre>${errorList.join("\n")}</pre></details>` : ""}
    `;
    document.getElementById("preview").innerHTML = report;
  }
</script>

</body>
</html>
