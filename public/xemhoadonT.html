<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Xem H√≥a ƒê∆°n T·∫°m</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    tr:hover {
      background-color: #f1f1f1;
      cursor: pointer;
    }

    input,
    select {
      margin: 4px;
      padding: 6px;
    }

    #popup {
      display: none;
      position: fixed;
      top: 10%;
      left: 10%;
      width: 500px;
      min-width: 350px;
      min-height: 200px;
      height: 400px;
      background: #fff;
      border: 2px solid #4884ce;
      overflow: auto;
      padding: 20px;
      z-index: 9999;
      box-shadow: 0 2px 18px rgba(0, 0, 0, 0.2);
      border-radius: 7px;
      resize: both;
      /* Cho ph√©p thay ƒë·ªïi k√≠ch th∆∞·ªõc */
    }

    #popup .drag-header {
      cursor: move;
      background: #f3f7fa;
      font-weight: bold;
      padding: 8px 10px;
      margin: -20px -20px 15px -20px;
      border-bottom: 1px solid #4884ce;
      border-radius: 7px 7px 0 0;
      user-select: none;
    }
  </style>
</head>

<body>
  <h2>üìã Tra c·ª©u H√≥a ƒê∆°n T·∫°m</h2>
  <label>T·ª´ ng√†y: <input type="date" id="locTuNgay"></label>
  <label>ƒê·∫øn ng√†y: <input type="date" id="locDenNgay"></label>

  <label>Nh√¢n vi√™n: <input type="text" id="locNV"></label>
  <label>S·ªë Hƒê: <input type="text" id="locSoHD"></label>
  <button onclick="taiDanhSachHoaDon()">üîç L·ªçc</button>

  <button id="btnGuiLai" onclick="guiLaiHoaDonDaChon()" disabled>üì§ G·ª≠i l·∫°i h√≥a ƒë∆°n</button>
  <div style="margin:10px 0;">
    <b>T·ªïng thanh to√°n c√°c h√≥a ƒë∆°n ƒëang hi·ªÉn th·ªã: </b>
    <span id="tongThanhToan" style="font-weight:bold;color:blue;">0</span>
  </div>


  <!-- Th√™m n√∫t x√≥a v√† c·ªôt s·ªë th·ª© t·ª±, checkbox -->
  <button onclick="xoaHoaDonDaChon()" style="margin-bottom:8px;">‚ùå X√≥a h√≥a ƒë∆°n ƒë√£ ch·ªçn</button>
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>‚úîÔ∏è</th>
        <th>S·ªë Hƒê</th>
        <th>Ng√†y</th>
        <th>NV</th>
        <th>Kh√°ch</th>
        <th>TT</th>
        <th>Ghi ch√∫</th>
        <th>Tr·∫°ng th√°i g·ª≠i</th>
      </tr>
    </thead>
    <tbody id="dsHoaDon"></tbody>
  </table>


  <div id="popup">
    <div class="drag-header" id="popupHeader">
      Chi ti·∫øt h√≥a ƒë∆°n: <span id="sohdCT"></span>
      <span style="float:right;cursor:pointer;color:#999;" onclick="dongPopup()">‚úñ</span>
    </div>

    <table>
      <thead>
        <tr>
          <th>M√£ SP</th>
          <th>T√™n SP</th>
          <th>Size</th>
          <th>SL</th>
          <th>Gi√°</th>
          <th>KM</th>
          <th>Th√†nh ti·ªÅn</th>
        </tr>
      </thead>
      <tbody id="ctHoaDon"></tbody>
    </table>
    <button onclick="dongPopup()">ƒê√≥ng</button>
  </div>

  <script>
    let sohdDangChon = null;

    const supabase = window.supabase.createClient(
      'https://rddjrmbyftlcvrgzlyby.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkZGpybWJ5ZnRsY3ZyZ3pseWJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NjU4MDQsImV4cCI6MjA2MjM0MTgwNH0.-0xtqxn6b9OBz4unTTvJ4klxizWhHa1iSuYGm7cOYTM'
    );

    async function taiDanhSachHoaDon() {
      // L·∫•y gi√° tr·ªã l·ªçc
      const tuNgay = document.getElementById("locTuNgay").value;
      const denNgay = document.getElementById("locDenNgay").value;
      const nv = document.getElementById("locNV").value.trim().toUpperCase();
      const sohd = document.getElementById("locSoHD").value.trim();

      let query = supabase
        .from('hoadon_banleT')
        .select('*')
        .order('ngay', { ascending: false })
        .order('sohd', { ascending: false }); // Kh√¥ng limit!

      if (tuNgay && denNgay) {
        query = query.gte('ngay', tuNgay).lte('ngay', denNgay);
      } else if (tuNgay) {
        query = query.gte('ngay', tuNgay);
      } else if (denNgay) {
        query = query.lte('ngay', denNgay);
      }

      if (nv) query = query.ilike('manv', `%${nv}%`);
      if (sohd) query = query.ilike('sohd', `%${sohd}%`);

      const { data, error } = await query;
      const tbody = document.getElementById("dsHoaDon");
      tbody.innerHTML = "";
      let tongTien = 0;

      if (error) return alert("L·ªói t·∫£i h√≥a ƒë∆°n: " + error.message);
      if (!data || !data.length) {
        document.getElementById('tongThanhToan').textContent = "0";
        return tbody.innerHTML = `<tr><td colspan="9">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
      }

      // T·∫°o t·ª´ng d√≤ng b·∫£ng v·ªõi s·ªë th·ª© t·ª±, checkbox
      data.forEach((hd, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
      <td>${idx + 1}</td>
      <td><input type="checkbox" class="chonHD" data-sohd="${hd.sohd}"></td>
      <td>${hd.sohd}</td>
      <td>${hd.ngay}</td>
      <td>${hd.tennv}</td>
      <td>${hd.khachhang}</td>
      <td>${hd.thanhtoan?.toLocaleString()}</td>
      <td>${hd.ghichu || ""}</td>
      <td style="color:${hd.trang_thai_gui === 'ƒê√£ g·ª≠i' ? 'green' : (hd.trang_thai_gui?.startsWith('L·ªói') ? 'red' : 'orange')}">
        ${hd.trang_thai_gui || 'Ch∆∞a g·ª≠i'}
      </td>
    `;
        tr.onclick = function (e) {
          if (e.target.tagName !== "INPUT") {
            chonHoaDon(hd.sohd, this, hd.trang_thai_gui);
            xemChiTiet(hd.sohd);
          }
        };
        tbody.appendChild(tr);
        tongTien += Number(hd.thanhtoan) || 0;
      });
      document.getElementById('tongThanhToan').textContent = tongTien.toLocaleString();
    }


    async function xemChiTiet(sohd) {
      document.getElementById("popup").style.display = "block";
      document.getElementById("sohdCT").textContent = sohd;

      const { data, error } = await supabase.from('ct_hoadon_banleT').select('*').eq('sohd', sohd);
      const tbody = document.getElementById("ctHoaDon");
      tbody.innerHTML = "";

      if (error) return tbody.innerHTML = `<tr><td colspan='7'>L·ªói: ${error.message}</td></tr>`;

      data.forEach(row => {
        const tt = (row.gia - row.km) * row.soluong;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.masp}</td><td>${row.tensp}</td><td>${row.size}</td><td>${row.soluong}</td><td>${row.gia}</td><td>${row.km}</td><td>${tt.toLocaleString()}</td>`;
        tbody.appendChild(tr);
      });
    }

    function dongPopup() {
      document.getElementById("popup").style.display = "none";
    }


    function chonHoaDon(sohd, row, trangThaiGui) {
      document.querySelectorAll("#dsHoaDon tr").forEach(tr => tr.style.backgroundColor = "");
      row.style.backgroundColor = "#ffe066";
      sohdDangChon = sohd;
      // Ch·ªâ b·∫≠t n√∫t n·∫øu h√≥a ƒë∆°n ch∆∞a g·ª≠i ho·∫∑c l·ªói
      document.getElementById("btnGuiLai").disabled = !(!trangThaiGui || trangThaiGui === 'Ch∆∞a g·ª≠i' || trangThaiGui.startsWith('L·ªói'));
    }

    async function guiLaiHoaDonDaChon() {
      if (!sohdDangChon) {
        alert("B·∫°n ch∆∞a ch·ªçn h√≥a ƒë∆°n!");
        return;
      }
      if (!confirm(`B·∫°n mu·ªën g·ª≠i l·∫°i h√≥a ƒë∆°n [${sohdDangChon}] l√™n Viettel?`)) return;

      // L·∫•y l·∫°i d·ªØ li·ªáu h√≥a ƒë∆°n & chi ti·∫øt
      const { data: hoadon } = await supabase
        .from('hoadon_banleT')
        .select('*')
        .eq('sohd', sohdDangChon)
        .single();

      const { data: chitiet } = await supabase
        .from('ct_hoadon_banleT')
        .select('*')
        .eq('sohd', sohdDangChon);

      if (!hoadon || !chitiet || chitiet.length === 0) {
        alert("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h√≥a ƒë∆°n!");
        return;
      }

      const json = taoDuLieuHoaDon(hoadon, chitiet);

      const response = await fetch('/api/guiHDDT', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data: json })
      });

      let result;
      try {
        result = await response.json();
      } catch (err) {
        alert("‚ùå L·ªói khi ƒë·ªçc ph·∫£n h·ªìi t·ª´ server.");
        return;
      }

      if (!response.ok) {
        alert(result?.message || '‚ùå G·ª≠i l·∫°i h√≥a ƒë∆°n th·∫•t b·∫°i!');
        return;
      }

      await supabase
        .from('hoadon_banleT')
        .update({ trang_thai_gui: 'ƒê√£ g·ª≠i' })
        .eq('sohd', sohdDangChon);

      alert("‚úÖ G·ª≠i l·∫°i h√≥a ƒë∆°n th√†nh c√¥ng!");
      taiDanhSachHoaDon();
    }

    // T·∫°o d·ªØ li·ªáu JSON chu·∫©n
    function taoDuLieuHoaDon(hoadon, chitiet) {
      let tongTien = Number(hoadon.thanhtoan) || chitiet.reduce((sum, item) => sum + Number(item.thanhtien), 0);
      return {
        generalInvoiceInfo: {
          sohd: hoadon.sohd, // truy·ªÅn sohd ƒë·ªÉ backend nh·∫≠n di·ªán c∆° s·ªü
          invoiceType: "02GTTT",
          templateCode: "2/001",
          invoiceSeries: hoadon.sohd.startsWith('bancs2T_') ? "C25MAT" : "C25MLH",
          invoiceIssuedDate: new Date().getTime(),
          currencyCode: "VND",
          adjustmentType: "1",
          paymentStatus: true,
          paymentType: "TM/CK",
          paymentTypeName: "TM/CK",
          cusGetInvoiceRight: true
        },
        buyerInfo: {
          sohd: hoadon.sohd, // truy·ªÅn c·∫£ ·ªü ƒë√¢y (ho·∫∑c ch·ªâ 1 n∆°i)
          buyerName: hoadon.khachhang || "Kh√°ch l·∫ª",
          buyerTaxCode: "",
          buyerAddressLine: hoadon.diadiem || "",
          buyerPhoneNumber: "",
          buyerEmail: "",
          buyerIdNo: "",
          buyerIdType: "",
          buyerBudgetCode: ""
        },
        sellerInfo: {
          sellerLegalName: "ƒê·∫∂NG L√ä HO√ÄN",
          sellerTaxCode: hoadon.sohd.startsWith('bancs2T_') ? "4600960665" : "4600370592",
          sellerAddressLine: "S·ªë nh√† 540, ƒë∆∞·ªùng 3/2, t·ªï 8, Ph∆∞·ªùng T√≠ch L∆∞∆°ng, TP Th√°i Nguy√™n, T·ªânh Th√°i Nguy√™n, Vi·ªát Nam",
          sellerPhoneNumber: "0916747401",
          sellerEmail: "cskt.viettelhue@gmail.com",
          sellerBankAccount: "123456789"
        },
        payments: [
          { paymentMethodName: "TM/CK", paymentAmount: tongTien }
        ],
        itemInfo: chitiet.map((item, index) => ({
          lineNumber: index + 1,
          itemCode: item.masp,
          itemName: item.tensp,
          unitName: item.dvt,
          quantity: Number(item.soluong),
          unitPrice: Number(item.gia) - Number(item.km || 0),
          itemTotalAmountWithoutTax: Number(item.thanhtien),
          taxPercentage: 0,
          taxAmount: 0,
          discount: 0,
          itemDiscount: Number(item.km) || 0
        })),
        summarizeInfo: {
          totalAmountWithoutTax: tongTien,
          totalTaxAmount: 0,
          totalAmountWithTax: tongTien,
          totalAmountWithTaxInWords: "B·ªën trƒÉm ngh√¨n ƒë·ªìng ch·∫µn",
          discountAmount: Number(hoadon.chietkhau) || 0
        },
        taxBreakdowns: [],
        metadata: [],
        customFields: [],
        deliveryInfo: {},
        meterReading: []
      };
    }

    // DRAG POPUP
    (function dragPopup() {
      let popup = document.getElementById('popup');
      let header = document.getElementById('popupHeader');
      let offsetX, offsetY, isDragging = false;
      header.onmousedown = function (e) {
        isDragging = true;
        let rect = popup.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
        document.onmousemove = function (ev) {
          if (isDragging) {
            popup.style.left = (ev.clientX - offsetX) + 'px';
            popup.style.top = (ev.clientY - offsetY) + 'px';
          }
        };
        document.onmouseup = function () { isDragging = false; document.onmousemove = null; };
      };
    })();

    // ƒê√≥ng popup b·∫±ng ph√≠m ESC
    document.addEventListener('keydown', function (e) {
      if (e.key === "Escape") dongPopup();
    });

    async function xoaHoaDonDaChon() {
      const checkboxes = document.querySelectorAll(".chonHD:checked");
      const sohdList = Array.from(checkboxes).map(cb => cb.dataset.sohd);

      if (sohdList.length === 0) return alert("‚ùó Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt h√≥a ƒë∆°n c·∫ßn x√≥a.");

      if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${sohdList.length} h√≥a ƒë∆°n kh·ªèi h·ªá th·ªëng?`)) return;

      // X√≥a chi ti·∫øt tr∆∞·ªõc
      const { error: errCT } = await supabase.from('ct_hoadon_banleT').delete().in('sohd', sohdList);
      if (errCT) {
        console.error("‚ùå L·ªói x√≥a chi ti·∫øt:", errCT.message);
        return alert("Kh√¥ng th·ªÉ x√≥a chi ti·∫øt h√≥a ƒë∆°n.");
      }

      // X√≥a h√≥a ƒë∆°n ch√≠nh
      const { error: errHD } = await supabase.from('hoadon_banleT').delete().in('sohd', sohdList);
      if (errHD) {
        console.error("‚ùå L·ªói x√≥a h√≥a ƒë∆°n:", errHD.message);
        return alert("Kh√¥ng th·ªÉ x√≥a h√≥a ƒë∆°n.");
      }

      alert(`‚úÖ ƒê√£ x√≥a ${sohdList.length} h√≥a ƒë∆°n.`);
      taiDanhSachHoaDon();
    }

    window.onload = function () {
      const today = new Date().toISOString().slice(0, 10);
      document.getElementById('locTuNgay').value = today;
      document.getElementById('locDenNgay').value = today;
      taiDanhSachHoaDon();
    };


  </script>
</body>

</html>
