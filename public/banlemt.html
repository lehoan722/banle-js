<!DOCTYPE html>

<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>H√≥a ƒë∆°n b√°n l·∫ª</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.min.css" />


    <style>
        body {
            font-family: Arial;
            margin: 0;
            height: 100%;
        }

        .header {
            background-color: #0078d7;
            color: white;
            text-align: center;
            padding: 10px;
            font-size: 28px;
            font-weight: bold;
        }

        .top-inputs {
            display: flex;
            padding: 5px;
            gap: 5px;
            background: #f4f4f4;
            align-items: center;
        }

        .tennv {
            display: flex;
            padding: 5px;
            gap: 5px;
            background: #0088cc;
            align-items: center;
            justify-content: flex-end;
            /* ƒê·∫©y h·∫øt sang ph·∫£i */
        }


        .top-inputs input,
        .top-inputs select {
            padding: 4px;
            font-size: 20px;
        }

        .top-inputs input {
            box-sizing: border-box;
        }

        #masp {
            width: 250px;
            background: cyan;
        }

        #soluong {
            width: 60px;
            background: yellow;
            text-align: center;
        }

        #dvt {
            width: 60px;
        }

        #size {
            width: 60px;
            text-align: center;
        }

        #gia,
        #khuyenmai,
        #thanhtien {
            width: 150px;
            text-align: right;
        }

        #ghichu {
            flex: 1;
        }

        .main {
            display: flex;
            height: calc(100vh - 150px);
            overflow: hidden;
        }

        .table-area {
            flex: 1;
            overflow: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th,
        table td {
            border: 1px solid #ccc;
            padding: 6px;
            text-align: center;
        }

        .sidebar {
            width: 360px;
            border-left: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .tabs {
            display: flex;
            background: #eee;
        }

        .tabs button {
            flex: 1;
            padding: 8px;
            cursor: pointer;
            border: none;
            background: #ddd;
        }

        .tabs button.active {
            background: white;
            font-weight: bold;
            border-bottom: 2px solid #0078d7;
        }

        .tab-content {
            flex: 1;
            padding: 10px;
            font-size: 13px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .sidebar input,
        .sidebar select {
            width: 100%;
            padding: 4px;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .checkbox-list label {
            display: block;
            margin-bottom: 2px;
        }

        .btn-big {
            width: 85%;
            font-size: 18px;
            font-weight: bold;
            padding: 10px;
            margin: 6px 0;
        }

        .red {
            background-color: darkred;
            color: white;
        }

        .gray {
            background-color: lightgray;
            color: black;
        }

        .product-image {
            width: 360px !important;
            height: 360px !important;
            display: block;
            object-fit: contain;
            /* Gi·ªØ nguy√™n t·ªâ l·ªá, kh√¥ng c·∫Øt ·∫£nh */
            object-position: center;
            background: #f5f5f5;
            /* M√†u n·ªÅn trung t√≠nh, c√≥ th·ªÉ ch·ªânh n·∫øu mu·ªën */
            border: 1px solid #ccc;
            margin: 0 auto;
        }


        .footer-buttons {
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
            /* d·ªìn tr√°i */
            flex-wrap: wrap;
            gap: 7px;
            padding: 5px 0 5px 8px;
            background: #dce9f9;
        }

        .footer-buttons button {
            margin-right: 4px;
            font-size: 15px;
            padding: 7px 13px;
            min-width: 85px;
        }


        .popup {
            display: none;
            position: fixed;
            top: 10%;
            left: 5%;
            width: 90%;
            height: 70%;
            background: white;
            border: 1px solid #ccc;
            z-index: 999;
            box-shadow: 0 0 10px #333;
        }

        .popup-content {
            padding: 10px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .popup-list {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #ddd;
            margin-top: 6px;
        }

        /* B·ªë c·ª•c nh√≥m nh·∫≠p li·ªáu */
        .tab-pane label {
            display: inline-block;
            width: 32%;
            box-sizing: border-box;
            padding-right: 4px;
            margin-bottom: 6px;
        }

        .tab-pane input,
        .tab-pane select {
            width: 100%;
        }

        .sidebar {
            width: 360px;
            border-left: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            /* ‚ö†Ô∏è CHUY·ªÇN T·ª™ space-between */
        }

        .tab-content {
            flex-grow: 0;
            /* ‚ö†Ô∏è KH√îNG chi·∫øm to√†n b·ªô chi·ªÅu cao */
        }


        #popupDanhMuc {
            display: none !important;
        }

        html,
        body {
            height: 100%;
        }

        body {
            height: 100%;
        }

        #app-container {
            min-height: 100vh;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .main {
            flex: 1 1 auto;
            display: flex;
            min-height: 0;
            height: 1px;
            overflow: hidden;
        }

        .table-area {
            flex: 1 1 auto;
            overflow: auto;
            min-height: 0;
            max-height: 100%;
            background: #fff;
        }

        .footer-userinfo,
        .footer-buttons {
            flex-shrink: 0;
            width: 75%;
            z-index: 100;
        }

        @media print {

            html,
            body {
                margin: 0 !important;
                padding: 0 !important;
                width: 80mm;
                /* ƒë√∫ng kh·ªï K80 */
                box-sizing: border-box;
            }

            body {
                /* X√≥a font-size m·∫∑c ƒë·ªãnh l·ªõn */
                font-size: 12px;
                line-height: 1.2;
            }

            /* X√≥a header/footer m·∫∑c ƒë·ªãnh c·ªßa tr√¨nh duy·ªát n·∫øu c√≥ */
            @page {
                margin: 0;
                size: 80mm auto;
            }
        }
    </style>


    <script>

        function switchTab(tabName) {
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.getElementById('btn_' + tabName).classList.add('active');
        }
        document.addEventListener("DOMContentLoaded", () => {
            switchTab("thongtin");
        });

        function dongPopupDM() {
            document.getElementById('popupDanhMuc').style.display = 'none';
        }
    </script>
</head>

<body>

    <style>
        .menu-bar {
            background: #0088cc;
            padding: 8px 20px;
            display: flex;
            gap: 30px;
            color: white;
            position: relative;
            z-index: 1000;
        }

        .menu-item {
            position: relative;
        }

        .menu-link {
            color: white;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
            padding: 6px 10px;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f1f1f1;
            min-width: 240px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            top: 100%;
            left: 0;
            z-index: 1001;
            padding: 6px 0;
        }

        .dropdown-content a {
            color: black;
            padding: 10px 16px;
            text-decoration: none;
            display: block;
            white-space: nowrap;
        }

        .dropdown-content a:hover {
            background-color: #ddd;
        }

        .menu-item:hover .dropdown-content {
            display: block;
        }

        .footer-userinfo {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            padding: 4px 0 4px 8px;
            background: #e5eef9;
            border-top: 1px solid #c7d3e9;
        }

        .footer-userinfo label {
            margin-bottom: 0;
            font-size: 15px;
        }

        .footer-userinfo input,
        .footer-userinfo select {
            padding: 3px 6px;
            font-size: 15px;
            margin-left: 2px;
        }
    </style>

    <div class="menu-bar">
        <div class="tennv">

            <label>
                <select id="diadiem">
                    <option value="cs1">C∆° s·ªü 1</option>
                    <option value="cs2">C∆° s·ªü 2</option>
                </select>
            </label>

            <label> <input id="ngay" type="date" /></label>
            <!-- <label>Gi·ªù <input id="gio" /></label> -->
            <input id="manv" type="password" placeholder="M√£ NV" />
            <input id="tennv" placeholder="T√™n NV" readonly />

            <button id="btnReloadSP" style="margin-left:10px">üîÑ T·∫£i</button>
        </div>
        <div class="menu-item">

            <span class="menu-link">üìÅ B√°o c√°o h√≥a ƒë∆°n</span>
            <div class="dropdown-content">

                <a href="xemhoadonT.html" target="_blank">Xem h√≥a ƒë∆°n bct</a>

                <a href="inmavachcs2.html" target="_blank">in m√£ v·∫°ch cs2</a>
                <a href="inmavachcs1.html" target="_blank">in m√£ v·∫°ch cs1</a>
                <a href="nhapdmhanghoa.html" target="_blank">nhap dm hang hoa</a>
                <a href="baocaohoadon.html" target="_blank">B√°o c√°o t·ªïng h·ª£p</a>
            </div>
        </div>
        <div class="menu-item">
            <span class="menu-link">üì¶ GIAO DICH</span>
            <div class="dropdown-content">
                <a href="banlemt.html" target="_blank">HOA DON BAN LE</a>
                <a href="nhapmoimt.html" target="_blank">HOA DON NHAP MOI</a>
                <a href="ccn1v2.html" target="_blank">CHUYEN CN 1V2</a>
                <a href="ccn2v1.html" target="_blank">CHUYEN CN 2v1</a>
                <a href="nhapdoikh.html" target="_blank">NHAP DOI TU KHACH</a>
                <a href="tralaincc.html" target="_blank">TRA LAI NHA CC</a>
                <a href="xuathuy.html" target="_blank">XUAT HUY HANG HONG</a>
                <a href="kiemkho.html" target="_blank">PHIEU KIEM KHO</a>


            </div>
        </div>
        <div class="menu-item">
            <span class="menu-link">üì¶ KHAC</span>
            <div class="dropdown-content">
                <a href="nhaphang1.html" target="_blank">Chi ti·∫øt nh·∫≠p h√†ng CS1</a>
                <a href="nhaphang2.html" target="_blank">Chi ti·∫øt nh·∫≠p h√†ng CS2</a>
                <a href="baocaonhap.html" target="_blank">T·ªïng h·ª£p nh·∫≠p theo ng√†y</a>
            </div>
        </div>


    </div>


    <div id="app-container" style="display:none;">


        <div class="top-inputs">
            <div style="position: relative;">
                <input id="masp" placeholder="M√£ SP" autocomplete="off" />
                <div id="popup_masp"
                    style="position: absolute; top: 100%; left: 0; width: 300px; max-height: 400px; background: #fff; border: 1px solid #ccc; display: none; overflow-y: auto; z-index: 10000;">
                </div>
            </div>
            <input id="soluong" value="1" />
            <input id="dvt" placeholder="DVT" />
            <input id="size" placeholder="SIZE" />
            <input id="gia" placeholder="Gi√° SP" />
            <input id="khuyenmai" placeholder="khuyen mai" />
            <input id="thanhtien" placeholder="Th√†nh ti·ªÅn" />
            <input id="sohd" placeholder="S·ªë Hƒê" />

            <input id="ghichu" placeholder="Ghi ch√∫ HH" />
            <button id="masp-search">üîç</button>
        </div>


        <div class="main">
            <div class="table-area">
                <table id="bangketqua">
                    <thead>
                        <tr>
                            <th>M√£ h√†ng</th>
                            <th>T√™n h√†ng</th>
                            <th>K√≠ch c·ª°</th>
                            <th>S.l∆∞·ª£ng</th>
                            <th>ƒêVT</th>
                            <th>ƒê∆°n gi√°</th>
                            <th>Khuy·∫øn m·∫°i</th>
                            <th>Th√†nh ti·ªÅn</th>

                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="sidebar">
                <div class="tabs">
                    <button id="btn_thongtin" onclick="switchTab('thongtin')">Th√¥ng tin h√≥a ƒë∆°n</button>
                    <button id="btn_tacvu" onclick="switchTab('tacvu')">Thao t√°c nhanh</button>
                </div>
                <div class="tab-content">
                    <div class="tab-pane" id="thongtin">

                        <label>H√¨nh th·ª©c TT <select id="hinhthuctt">
                                <option value="tm">Ti·ªÅn m·∫∑t</option>
                                <option value="ck">Chuy·ªÉn kho·∫£n</option>
                            </select></label>

                        <label>Chi·∫øt kh·∫•u <input id="chietkhau" /></label>
                        <label>T·ªïng KM <input id="tongkm" readonly="" /></label>

                        <label>M·∫∑t h√†ng <input id="mathang" readonly="" /></label>
                        <label>T·ªïng SL <input id="tongsl" readonly="" /></label>
                        <label>V·ªã tr√≠ <input id="vitri" readonly="" /></label>
                        <!-- khu vuc t√¨m kh√°ch h√†ng -->
                        <div style="position: relative; display: inline-block; width: 220px; vertical-align: middle;">
                            <input id="makh" placeholder="m√£ kh√°ch"
                                style="width:100%;padding-right:32px;box-sizing:border-box;" autocomplete="off">
                            <button id="btnPopupKH" type="button"
                                style="position:absolute;right:2px;top:50%;transform:translateY(-50%);height:26px;width:28px;border:none;background:transparent;cursor:pointer;outline:none;">
                                üîç
                            </button>
                        </div>
                        <label>Kh√°ch h√†ng <input id="khachhang" readonly="" /></label>

                        <!-- Popup t√¨m kh√°ch h√†ng -->
                        <div id="popupTimKH"
                            style="display:none; position:fixed; top:100px; left:40%; background:#fff; border:1px solid #ccc; z-index:9999; min-width:340px; max-height:400px; overflow:auto">
                            <input id="txtSearchKH" placeholder="Nh·∫≠p m√£/t√™n kh√°ch..." style="width:95%;margin:5px">
                            <table id="tableKH" style="width:100%;font-size:15px"></table>
                        </div>
                        <!-- het khu vuc t√¨m kh√°ch h√†ng -->
                    </div>
                    <div class="tab-pane" id="tacvu">
                        <div class="checkbox-list">
                            <label><input id="nhapnhanh" type="checkbox" /> quan size all</label>
                            <label><input id="size45" type="checkbox" />quan size GD</label>
                            <label><input id="bansieunhanh" type="checkbox" /> B√°n si√™u nhanh</label>
                            <label><input id="inSauKhiLuu" type="checkbox" /> In sau khi l∆∞u</label>
                            <label><input id="inKhongHoi" type="checkbox" /> In kh√¥ng h·ªèi</label>
                            <label><input checked="" type="checkbox" /> Hi·ªÉn th·ªã h√¨nh ·∫£nh</label>


                            <label><input type="checkbox" /> C·ªông d·ªìn s·ªë l∆∞·ª£ng</label>
                        </div>
                    </div>
                </div>

                <div class="btn-big red" style="font-size: 20px; padding: 6px 10px;">
                    T·ªïng ph·∫£i tr·∫£
                    <input id="phaithanhtoan"
                        style="float:right; width:110px; text-align:right; font-size:20px; font-weight:bold; background:none; border:none; color:white; padding:0; margin:0;" />
                </div>
                <div class="btn-big gray" style="font-size: 20px; padding: 6px 10px;">
                    Kh√°ch thanh to√°n
                    <input id="khachtra"
                        style="float:right; width:110px; text-align:right; font-size:20px; font-weight:bold; background:none; border:none; color:#222; padding:0; margin:0;" />
                </div>
                <div class="btn-big gray" style="font-size: 20px; padding: 6px 10px;">
                    C√≤n l·∫°i
                    <input id="conlai"
                        style="float:right; width:110px; text-align:right; font-size:20px; font-weight:bold; background:none; border:none; color:#222; padding:0; margin:0;"
                        readonly />
                </div>



                <img alt="·∫¢nh s·∫£n ph·∫©m" class="product-image"
                    src="https://rddjrmbyftlcvrgzlyby.supabase.co/storage/v1/object/public/anhsanpham//no-image.jpg" />
            </div>
        </div>


        <div class="footer-buttons">
            <button id="them">Th√™m m·ªõi</button>
            <button id="btn-luu" onclick="luuHoaDonCaHaiBan()">üíæ L∆∞u</button>

            <button id="quaylai">Quay l·∫°i</button>
            <button id="tieptuc">Ti·∫øp t·ª•c</button>
            <button id="xemin">Xem in</button>
            <button id="btnCopy">Copy</button>
            <button id="xuatexcel">Xu·∫•t Excel</button>
            <button id="btn-logout">THOAT PM</button>

            <!-- Popup t√¨m kh√°ch h√†ng
             <button id="xuatexcel">Xu·∫•t Excel</button>
             <button id="timkiem">T√¨m ki·∫øm</button>
             <button id="luu">L∆∞u</button>
            <button onclick="luuHoaDonQuaAPI()">L∆∞u API</button>
            
            -->

        </div>

        <div class="top-inputs">
            ----------------------------------------------------------
        </div>
        <div class="top-inputs">
            ----------------------------------------------------------
        </div>


        <div class="popup" id="popupDanhMuc">
            <div class="popup-content">
                <strong>T√¨m ki·∫øm m√£ s·∫£n ph·∫©m</strong>
                <input id="timKiemMaspPopup" placeholder="Nh·∫≠p t·ª´ kh√≥a..." />
                <div class="popup-list" id="danhSachSP"></div>
                <button onclick="dongPopupDM()">ƒê√≥ng</button>
            </div>
        </div>
        <!-- ‚úÖ Popup x√°c th·ª±c s·ª≠a h√≥a ƒë∆°n -->
        <div id="popupXacThucSua" style="display:none; position:fixed; top:30%; left:50%; transform:translate(-50%, -50%);
  background:white; padding:20px; border:1px solid #ccc; z-index:9999; box-shadow: 0 0 10px #000;">
            <h3>X√°c th·ª±c s·ª≠a h√≥a ƒë∆°n</h3>
            <input id="xacmanv" placeholder="M√£ nh√¢n vi√™n"
                style="display:block; margin-bottom:6px; width:100%; padding:6px;" />
            <input id="xacmatkhau" placeholder="M·∫≠t kh·∫©u" type="password"
                style="display:block; margin-bottom:10px; width:100%; padding:6px;" />
            <button onclick="xacNhanSuaHoaDon()">X√°c nh·∫≠n</button>
            <button onclick="document.getElementById('popupXacThucSua').style.display='none'">H·ªßy</button>
        </div>

        <!-- Popup x√°c nh·∫≠n th√™m m·ªõi -->
        <div id="popupThemMoi" class="popup-confirm" style="display:none; position:fixed; top:30%; left:50%; transform:translate(-50%,-50%);
  background:white; border:1px solid #888; padding:20px; z-index:10000; box-shadow:0 0 10px #000;">
            <h3>B·∫°n c√≥ th·ª±c s·ª± mu·ªën th√™m m·ªõi?</h3>
            <div style="text-align:center; margin-top:10px;">
                <button id="btnThemMoiCo">‚úÖ C√≥</button>
                <button onclick="dongTatCaPopup()">‚ùå Kh√¥ng</button>
            </div>
        </div>

        <!-- Popup nh·∫≠p m√£ s·∫£n ph·∫©m m·ªõi -->
        <div id="popupNhapMaMoi" class="popup-confirm"
            style="display:none; position:fixed; top:10%; left:50%; transform:translate(-50%,0);
  background:white; border:1px solid #888; padding:20px; z-index:10001; box-shadow:0 0 10px #000; width:400px; max-height:90%; overflow:auto;">
            <h3>Th√™m m√£ s·∫£n ph·∫©m m·ªõi</h3>
            <div id="formFields"></div>
            <button onclick="luuMaSanPhamMoi()">L∆∞u m√£ m·ªõi</button>
            <button onclick="document.getElementById('popupNhapMaMoi').style.display='none'">H·ªßy</button>
            <button onclick="moCauHinhTruong()">‚öô C·∫•u h√¨nh hi·ªÉn th·ªã</button>
        </div>

        <div id="popupCauHinh" class="popup-confirm" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%);
  background:white; z-index:10010; border:1px solid #888; padding:20px; width:400px;">
            <h3>C·∫•u h√¨nh tr∆∞·ªùng hi·ªÉn th·ªã</h3>
            <div id="dsCauHinhTruong"></div>
            <div style="text-align:right; margin-top:10px;">
                <button onclick="luuCauHinhTruong()">L∆∞u</button>
                <button onclick="document.getElementById('popupCauHinh').style.display='none'">ƒê√≥ng</button>
            </div>
        </div>



        <div id="popupBangDanhMuc" class="popup"
            style="display:none; position:fixed; top:5%; left:5%; width:90%; height:85%; background:white; z-index:9999; border:1px solid #ccc; box-shadow: 0 0 10px #000;">
            <div style="padding:10px; display:flex; justify-content:space-between; align-items:center;">
                <strong>Danh m·ª•c h√†ng h√≥a</strong>
                <button onclick="document.getElementById('popupBangDanhMuc').style.display='none'">ƒê√≥ng</button>
            </div>
            <div style="padding: 0 10px 10px;">
                <input id="timKiemMaspDM" placeholder="T√¨m m√£ s·∫£n ph·∫©m..." oninput="timLaiTrongBangDM()"
                    style="width: 300px; padding: 4px;" />
                <button onclick="chonDongDeSua()">‚úèÔ∏è S·ª≠a danh m·ª•c</button>

            </div>
            <div id="hotDanhMuc" style="height: calc(100% - 100px); margin: 0 10px;"></div>
        </div>

        <!-- ‚úÖ Popup nh·∫≠p/s·ª≠a m√£ s·∫£n ph·∫©m m·ªõi -->
        <div id="popupNhapHangHoa"
            style="display:none; position:fixed; top:5%; left:50%; transform:translateX(-50%);
  background:white; border:1px solid #888; padding:20px; z-index:10003; width:550px; max-height:90%; overflow:auto; box-shadow:0 0 10px #000;">
            <h3 id="tieudePopupHangHoa" style="text-align:center; margin-bottom:12px;">Th√¥ng tin s·∫£n ph·∫©m</h3>

            <div id="fieldsNhapHangHoa"></div>

            <div id="footerHangHoa" style="margin-top:10px; font-size:13px; color:#444;"></div>

            <div style="margin-top:14px; text-align:center;">
                <button onclick="themTiepSanPham()">‚ûï Th√™m m·ªõi</button>
                <button onclick="luuHangHoa()">üíæ L∆∞u d·ªØ li·ªáu</button>
                <button onclick="document.getElementById('popupNhapHangHoa').style.display='none'">‚Ü©Ô∏è Tr·ªü v·ªÅ</button>
                <button onclick="moPopupCauHinh()">‚öô C·∫•u h√¨nh hi·ªÉn th·ªã</button> <!-- ‚úÖ m·ªõi th√™m -->
            </div>


        </div>
    </div>

    <!-- ƒêƒÉng nh·∫≠p Supabase -->
    <div id="login-container"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:99999;">
        <div style="background:#f9f9f9; padding:30px; border-radius:8px; box-shadow:0 0 10px #ccc;">
            <h2>ƒêƒÉng nh·∫≠p h·ªá th·ªëng</h2>
            <form id="form-login" onsubmit="dangNhap(); return false;">
                <label>Email ƒëƒÉng nh·∫≠p:</label><br />
                <input type="email" id="login-email" ...><br />
                <!-- Th√™m ƒëo·∫°n sau: -->
                <label>C∆° s·ªü b√°n h√†ng:</label><br />
                <select id="login-cs" style="width:200px; padding:6px;">
                    <option value="">-- Ch·ªçn c∆° s·ªü --</option>
                    <option value="cs1">C∆° s·ªü 1</option>
                    <option value="cs2">C∆° s·ªü 2</option>
                </select><br /><br />
                <div class="login-field">
                    <label for="login-manv">M√£ nh√¢n vi√™n</label><br />
                    <input type="password" id="login-manv" autocomplete="off" placeholder="Nh·∫≠p m√£ nh√¢n vi√™n"
                        required />
                </div>
                <label>M·∫≠t kh·∫©u:</label><br />
                <input type="password" id="login-password" ...><br /><br />

                <button type="submit" style="padding: 8px 16px;">ƒêƒÉng nh·∫≠p</button>
                <p id="login-error" style="color:red; margin-top:10px;"></p>
            </form>

        </div>

    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const supabaseUrl = 'https://rddjrmbyftlcvrgzlyby.supabase.co';  // <-- Thay url d·ª± √°n c·ªßa b·∫°n n·∫øu kh√°c
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkZGpybWJ5ZnRsY3ZyZ3pseWJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NjU4MDQsImV4cCI6MjA2MjM0MTgwNH0.-0xtqxn6b9OBz4unTTvJ4klxizWhHa1iSuYGm7cOYTM'; // <-- Thay ƒë√∫ng anon key
        window.supabase = createClient(supabaseUrl, supabaseKey);

        // √Ånh x·∫° email sang c∆° s·ªü b√°n h√†ng
        function getDiaDiemFromEmail(email) {
            if (!email) return "";
            email = email.trim().toLowerCase();
            if (email === "khohangcs1@gmail.com") return "cs1";
            if (email === "khohangcs2@gmail.com") return "cs2";
            // Th√™m c√°c √°nh x·∫° email ‚Üí c∆° s·ªü kh√°c t·∫°i ƒë√¢y n·∫øu c·∫ßn
            return "";
        }

        // S·ª± ki·ªán khi ng∆∞·ªùi d√πng nh·∫≠p email xong (r·ªùi kh·ªèi √¥ email)
        document.getElementById("login-email").addEventListener("blur", function () {
            const email = this.value.trim();
            const cs = getDiaDiemFromEmail(email);
            const csSelect = document.getElementById("login-cs");
            if (cs) {
                csSelect.value = cs;
                csSelect.disabled = true; // Kh√¥ng cho ch·ªçn l·∫°i
            } else {
                csSelect.value = "";
                csSelect.disabled = false; // Cho ch·ªçn khi kh√¥ng n·∫±m trong danh s√°ch
            }
        });

        window.dangNhap = async function () {
            const email = document.getElementById('login-email').value.trim().toLowerCase();
            const password = document.getElementById('login-password').value.trim();
            const cs = document.getElementById('login-cs').value;
            const manv = document.getElementById('login-manv').value.trim().toUpperCase();
            const statusEl = document.getElementById('login-error');

            // Ki·ªÉm tra ƒë·∫ßu v√†o
            if (!email || !password) {
                statusEl.textContent = 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß email v√† m·∫≠t kh·∫©u';
                statusEl.style.color = 'red';
                return;
            }
            if (!cs) {
                statusEl.textContent = 'Vui l√≤ng ch·ªçn c∆° s·ªü b√°n h√†ng!';
                statusEl.style.color = 'red';
                return;
            }
            if (!manv) {
                statusEl.textContent = 'Vui l√≤ng nh·∫≠p m√£ nh√¢n vi√™n!';
                statusEl.style.color = 'red';
                return;
            }

            // 1. ƒêƒÉng nh·∫≠p Supabase tr∆∞·ªõc!
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                statusEl.textContent = `‚ùå ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: ${error.message}`;
                statusEl.style.color = 'red';
                return;
            }

            // 2. Sau khi ƒëƒÉng nh·∫≠p th√†nh c√¥ng, l·∫•y th√¥ng tin nh√¢n vi√™n
            // ƒê·∫£m b·∫£o session Supabase (ph√≤ng tr∆∞·ªùng h·ª£p ch·∫≠m set session)
            await window.supabase.auth.setSession({
                access_token: data.session.access_token,
                refresh_token: data.session.refresh_token
            });

            // Truy v·∫•n b·∫£ng nh√¢n vi√™n v·ªõi RLS ƒë√£ m·ªü
            const { data: nvArr, error: errNV } = await supabase
                .from('dmnhanvien')
                .select('manv, tennv, sua_hoadon')
                .eq('manv', manv);

            if (errNV || !nvArr || nvArr.length === 0) {
                statusEl.textContent = '‚ùå M√£ nh√¢n vi√™n kh√¥ng ƒë√∫ng ho·∫∑c kh√¥ng t·ªìn t·∫°i!';
                statusEl.style.color = 'red';

                // ƒêƒÉng xu·∫•t ngay n·∫øu nh·∫≠p m√£ nh√¢n vi√™n sai!
                await supabase.auth.signOut();
                localStorage.clear();
                sessionStorage.clear();

                document.getElementById('login-container').style.display = '';
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('login-manv').focus();
                return;
            }

            const nv = nvArr[0];

            // L∆∞u th√¥ng tin v√†o localStorage
            localStorage.setItem("diadiem", cs);
            localStorage.setItem('supabase_access_token', data.session.access_token);
            localStorage.setItem("manv", nv.manv);
            localStorage.setItem("tennv", nv.tennv);
            localStorage.setItem("quyen_sua_hoadon", nv.sua_hoadon ? "true" : "false");

            // ·∫®n form ƒëƒÉng nh·∫≠p, hi·ªÉn th·ªã app
            statusEl.textContent = '‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng!';
            statusEl.style.color = 'green';
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('app-container').style.display = '';

            // C·∫≠p nh·∫≠t l√™n giao di·ªán b√°n h√†ng n·∫øu c√≥ input manv/tennv
            document.getElementById('manv') && (document.getElementById('manv').value = nv.manv, document.getElementById('manv').readOnly = true);
            document.getElementById('tennv') && (document.getElementById('tennv').value = nv.tennv, document.getElementById('tennv').readOnly = true);
            // Th√™m d√≤ng n√†y:
            capNhatQuyenGiaoDien();

            // Kh·ªüi t·∫°o ·ª©ng d·ª•ng
            import('./scripts/main.js').then(module => {
                if (module.khoiTaoUngDung) module.khoiTaoUngDung();
            });
        };



        // dang xuat
        document.getElementById('btn-logout').onclick = async function () {
            if (window.supabase && window.supabase.auth) {
                await window.supabase.auth.signOut();
                localStorage.clear();
                sessionStorage.clear();
                localStorage.removeItem("quyen_sua_hoadon");

            }
            //document.getElementById('login-email').value = "";
            //document.getElementById('login-password').value = "";
            document.getElementById('login-manv').value = "";
            document.getElementById('login-error').textContent = "";
            document.getElementById('login-container').style.display = '';
            document.getElementById('app-container').style.display = 'none';

            document.getElementById('login-manv').focus();
        };

        function capNhatQuyenGiaoDien() {
            // L·∫•y quy·ªÅn t·ª´ localStorage
            const quyenSua = localStorage.getItem("quyen_sua_hoadon") === "true";
            // N·∫øu d√πng ki·ªÉu s·ªë: const quyenSua = localStorage.getItem("quyen_sua_hoadon") === "1";
            // N√∫t quay l·∫°i
            document.getElementById('quaylai') && (document.getElementById('quaylai').disabled = !quyenSua);
            // N√∫t ti·∫øp t·ª•c
            document.getElementById('tieptuc') && (document.getElementById('tieptuc').disabled = !quyenSua);
            // N√∫t ti·∫øp t·ª•c
            document.getElementById('btn-luu') && (document.getElementById('btn-luu').disabled = !quyenSua);

            // N·∫øu mu·ªën ·∫©n n√∫t thay v√¨ disable th√¨ d√πng:
            // document.getElementById('quaylai').style.display = quyenSua ? "" : "none";
            // document.getElementById('tieptuc').style.display = quyenSua ? "" : "none";
        }

    </script>

    <script type="module">
        // N√∫t k√≠nh l√∫p c·∫°nh √¥ nh·∫≠p m√£ KH
        document.getElementById('btnPopupKH').onclick = showPopupTimKH;

        // Nh·∫•n F2 trong √¥ m√£ kh√°ch c≈©ng b·∫≠t popup
        document.getElementById('makh').addEventListener('keydown', function (e) {
            if (e.key === 'F2') {
                e.preventDefault();
                showPopupTimKH();
            }
        });

        // H√†m show popup
        function showPopupTimKH() {
            const popup = document.getElementById('popupTimKH');
            popup.style.display = '';
            document.getElementById('txtSearchKH').value = '';
            document.getElementById('txtSearchKH').focus();
            loadListKH('');
        }

        // T√¨m ki·∫øm realtime theo k√Ω t·ª± g√µ
        document.getElementById('txtSearchKH').oninput = function () {
            loadListKH(this.value.trim());
        };

        // H√†m load danh s√°ch KH (g·ªçi Supabase)
        async function loadListKH(keyword) {
            const table = document.getElementById('tableKH');
            table.innerHTML = `<tr><td>ƒêang t√¨m...</td></tr>`;
            let query = window.supabase.from('dmkhachhang').select('makh,tenkh').limit(30);
            if (keyword) {
                query = query.or(`makh.ilike.%${keyword}%,tenkh.ilike.%${keyword}%`);
            }
            const { data, error } = await query;
            if (error || !data || !data.length) {
                table.innerHTML = '<tr><td>Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng ph√π h·ª£p.</td></tr>';
                return;
            }
            table.innerHTML = data.map(kh =>
                `<tr class="chonkh" style="cursor:pointer" data-makh="${kh.makh}" data-tenkh="${kh.tenkh}">
        <td>${kh.makh}</td><td>${kh.tenkh}</td>
      </tr>`
            ).join('');
            Array.from(table.querySelectorAll('.chonkh')).forEach(row => {
                row.onclick = function () {
                    document.getElementById('makh').value = this.dataset.makh;
                    document.getElementById('khachhang').value = this.dataset.tenkh;
                    document.getElementById('popupTimKH').style.display = 'none';
                }
            });
        }

        // Copy b·∫£ng sang clipboard, c√≥ c·∫£ d√≤ng ti√™u ƒë·ªÅ
        document.getElementById('btnCopy').onclick = function () {
            const table = document.getElementById('bangketqua');
            let str = '';

            // 1. Copy d√≤ng ti√™u ƒë·ªÅ (thead)
            const thead = table.querySelector('thead');
            if (thead) {
                const headerCells = thead.rows[0].cells;
                let headerLine = [];
                for (let cell of headerCells) {
                    headerLine.push(cell.innerText);
                }
                str += headerLine.join('\t') + '\n';
            }

            // 2. Copy t·ª´ng d√≤ng d·ªØ li·ªáu (tbody)
            for (let row of table.querySelectorAll('tbody tr')) {
                let line = [];
                for (let cell of row.cells) {
                    line.push(cell.innerText);
                }
                str += line.join('\t') + '\n';
            }

            navigator.clipboard.writeText(str)
                .then(() => alert('ƒê√£ copy ra clipboard! D√°n v√†o Excel ƒë∆∞·ª£c lu√¥n.'));
        };


        // D√°n t·ª´ clipboard (Excel) v√†o b·∫£ng web
        document.getElementById('bangketqua').addEventListener('paste', function (e) {
            e.preventDefault();
            const text = e.clipboardData.getData('text/plain');
            const rows = text.trim().split('\n').map(r => r.split('\t'));
            const tbody = document.getElementById('bangketqua').querySelector('tbody');
            tbody.innerHTML = '';
            rows.forEach(rowArr => {
                if (rowArr.length < 2) return;
                const tr = document.createElement('tr');
                rowArr.forEach(cell => {
                    const td = document.createElement('td');
                    td.innerText = cell;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            // ‚úÖ C·∫≠p nh·∫≠t l·∫°i d·ªØ li·ªáu JS sau khi d√°n xong
            capNhatBangKetQuaTuDOM();

            // ‚úÖ C·∫≠p nh·∫≠t t·ªïng s·ªë l∆∞·ª£ng v√† t·ªïng khuy·∫øn m√£i
            if (typeof capNhatThongTinTong === "function") {
                capNhatThongTinTong(window.bangKetQua || {});
            }

            // Log ƒë·ªÉ ki·ªÉm tra
            console.log("window.bangKetQua:", window.bangKetQua);
            if (typeof bangKetQua !== "undefined") {
                console.log("bangKetQua:", bangKetQua);
            }
        });



        // ƒê√≥ng popup khi b·∫•m ESC ho·∫∑c click ra ngo√†i
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') document.getElementById('popupTimKH').style.display = 'none';
        });
        document.addEventListener('click', function (e) {
            const p = document.getElementById('popupTimKH');
            if (p.style.display === '' && !p.contains(e.target) && e.target.id !== 'btnPopupKH') {
                p.style.display = 'none';
            }
        });

        document.getElementById('btnReloadSP').onclick = window.taiLaiSanPhamData;
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const img = document.querySelector('.product-image');
            if (img) {
                img.addEventListener('dblclick', function () {
                    window.open('https://banle-js.vercel.app/xembaocao.html', '_blank');
                });
            }
        });
    </script>



    <script type="module" src="scripts/viettelInvoice.js"></script>

</body>

</html>
