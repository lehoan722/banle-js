<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Xem hóa đơn sau đăng nhập</title>
  <script type="module" src="/public/scripts/supabaseClient.js"></script>
</head>
<body>
  <h2>Đăng nhập để xem hóa đơn</h2>

  <div id="login-form">
    <input type="email" id="email" placeholder="Email" /><br/>
    <input type="password" id="password" placeholder="Mật khẩu" /><br/>
    <button onclick="dangNhap()">Đăng nhập</button>
    <p id="login-status" style="color:red;"></p>
  </div>

  <div id="report-container" style="display:none;">
    <h3>Danh sách hóa đơn bán lẻ</h3>
    <table border="1" id="hoadon-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Số hóa đơn</th>
          <th>Ngày</th>
          <th>Người tạo</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="dangXuat()">Đăng xuất</button>
  </div>

  <script type="module">
    const supabase = window.supabase;

    // Kiểm tra đăng nhập tự động
    supabase.auth.getSession().then(({ data: { session } }) => {
      if (session) {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('report-container').style.display = 'block';
        taiHoaDon();
      }
    });

    // Hàm đăng nhập
    window.dangNhap = async function () {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      const { error } = await supabase.auth.signInWithPassword({ email, password });

      if (error) {
        document.getElementById('login-status').innerText = "Đăng nhập thất bại: " + error.message;
      } else {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('report-container').style.display = 'block';
        taiHoaDon();
      }
    };

    // Hàm đăng xuất
    window.dangXuat = async function () {
      await supabase.auth.signOut();
      location.reload();
    };

    // Hàm tải dữ liệu hóa đơn
    async function taiHoaDon() {
      const { data, error } = await supabase
        .from("hoadon_banle")
        .select("id, sohd, ngay, nguoi_tao")
        .limit(20)
        .order("ngay", { ascending: false });

      const tbody = document.querySelector("#hoadon-table tbody");
      tbody.innerHTML = "";

      if (error) {
        tbody.innerHTML = "<tr><td colspan='4'>Lỗi: " + error.message + "</td></tr>";
        return;
      }

      for (const hd of data) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${hd.id}</td>
          <td>${hd.sohd}</td>
          <td>${hd.ngay || ''}</td>
          <td>${hd.nguoi_tao || ''}</td>
        `;
        tbody.appendChild(tr);
      }
    }
  </script>
</body>
</html>
