
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ƒêƒÉng nh·∫≠p Supabase</title>
  <style>
    body { font-family: Arial; padding: 40px; }
    #login-form { border: 1px solid #ccc; padding: 20px; width: 300px; margin: auto; }
    #app-content { display: none; margin-top: 40px; }
  </style>
</head>
<body>

<div id="login-form">
  <h3>ƒêƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng ph·∫ßn m·ªÅm</h3>
  <input id="login-email" type="email" placeholder="Email ƒëƒÉng nh·∫≠p" style="width: 100%;"><br><br>
  <input id="login-password" type="password" placeholder="M·∫≠t kh·∫©u" style="width: 100%;"><br><br>
  <button onclick="dangNhap()">ƒêƒÉng nh·∫≠p</button>
  <div id="login-status" style="margin-top:10px;color:red;"></div>
</div>

<div id="app-content">
  
  <!DOCTYPE html>
<html lang="vi"> 
<head>
  <meta charset="UTF-8">
  <title>Xem H√≥a ƒê∆°n B√°n L·∫ª</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    tr:hover { background-color: #f1f1f1; cursor: pointer; }
    input, select { margin: 4px; padding: 6px; }
    #popup { display: none; position: fixed; top: 10%; left: 10%; width: 80%; height: 70%; background: #fff; border: 1px solid #888; overflow: auto; padding: 20px; z-index: 9999; }
  </style>
</head>
<body>
  <h2>üìã Tra c·ª©u H√≥a ƒê∆°n B√°n L·∫ª</h2>
  <label>Ng√†y: <input type="date" id="locNgay"></label>
  <label>Nh√¢n vi√™n: <input type="text" id="locNV"></label>
  <label>S·ªë Hƒê: <input type="text" id="locSoHD"></label>
  <button onclick="taiDanhSachHoaDon()">üîç L·ªçc</button>

  <table>
    <thead>
      <tr><th>S·ªë Hƒê</th><th>Ng√†y</th><th>NV</th><th>Kh√°ch</th><th>TT</th><th>Ghi ch√∫</th></tr>
    </thead>
    <tbody id="dsHoaDon"></tbody>
  </table>

  <div id="popup">
    <h3>Chi ti·∫øt h√≥a ƒë∆°n: <span id="sohdCT"></span></h3>
    <table>
      <thead>
        <tr><th>M√£ SP</th><th>T√™n SP</th><th>Size</th><th>SL</th><th>Gi√°</th><th>KM</th><th>Th√†nh ti·ªÅn</th></tr>
      </thead>
      <tbody id="ctHoaDon"></tbody>
    </table>
    <button onclick="dongPopup()">ƒê√≥ng</button>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://rddjrmbyftlcvrgzlyby.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkZGpybWJ5ZnRsY3ZyZ3pseWJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NjU4MDQsImV4cCI6MjA2MjM0MTgwNH0.-0xtqxn6b9OBz4unTTvJ4klxizWhHa1iSuYGm7cOYTM'
    );

    async function taiDanhSachHoaDon() {
      const ngay = document.getElementById("locNgay").value;
      const nv = document.getElementById("locNV").value.trim().toUpperCase();
      const sohd = document.getElementById("locSoHD").value.trim();

      let query = supabase.from('hoadon_banle').select('*').order('ngay', { ascending: false }).limit(100);

      if (ngay) query = query.eq('ngay', ngay);
      if (nv) query = query.ilike('manv', `%${nv}%`);
      if (sohd) query = query.ilike('sohd', `%${sohd}%`);

      const { data, error } = await query;

      const tbody = document.getElementById("dsHoaDon");
      tbody.innerHTML = "";

      if (error) return alert("L·ªói t·∫£i h√≥a ƒë∆°n: " + error.message);

      data.forEach(hd => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${hd.sohd}</td><td>${hd.ngay}</td><td>${hd.tennv}</td><td>${hd.khachhang}</td><td>${hd.thanhtoan?.toLocaleString()}</td><td>${hd.ghichu || ""}</td>`;
        tr.onclick = () => xemChiTiet(hd.sohd);
        tbody.appendChild(tr);
      });
    }

    async function xemChiTiet(sohd) {
      document.getElementById("popup").style.display = "block";
      document.getElementById("sohdCT").textContent = sohd;
      const { data, error } = await supabase.from('ct_hoadon_banle').select('*').eq('sohd', sohd);
      const tbody = document.getElementById("ctHoaDon");
      tbody.innerHTML = "";
      if (error) return tbody.innerHTML = `<tr><td colspan='7'>L·ªói: ${error.message}</td></tr>`;
      data.forEach(row => {
        const tt = (row.gia - row.km) * row.soluong;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.masp}</td><td>${row.tensp}</td><td>${row.size}</td><td>${row.soluong}</td><td>${row.gia}</td><td>${row.km}</td><td>${tt.toLocaleString()}</td>`;
        tbody.appendChild(tr);
      });
    }

    function dongPopup() {
      document.getElementById("popup").style.display = "none";
    }

    window.onload = taiDanhSachHoaDon;
  </script>
</body>
</html>


<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabaseUrl = 'https://rddjrmbyftlcvrgzlyby.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkZGpybWJ5ZnRsY3ZyZ3pseWJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NjU4MDQsImV4cCI6MjA2MjM0MTgwNH0.-0xtqxn6b9OBz4unTTvJ4klxizWhHa1iSuYGm7cOYTM'; // ‚Üê thay b·∫±ng anon key th·∫≠t c·ªßa b·∫°n
  const supabase = createClient(supabaseUrl, supabaseKey);

  window.dangNhap = async function () {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value.trim();
    const statusEl = document.getElementById('login-status');

    if (!email || !password) {
      statusEl.textContent = 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß email v√† m·∫≠t kh·∫©u';
      return;
    }

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });

    if (error) {
      statusEl.textContent = `‚ùå ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: ${error.message}`;
    } else {
      statusEl.style.color = 'green';
      statusEl.textContent = '‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng!';
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('app-content').style.display = 'block';

      // Kh·ªüi t·∫°o Supabase client c√≥ token (ƒë·ªÉ g·ªçi truy v·∫•n)
      window.supabaseUser = createClient(supabaseUrl, supabaseKey, {
        global: {
          headers: {
            Authorization: `Bearer ${data.session.access_token}`,
          },
        },
      });

      // Sau khi ƒëƒÉng nh·∫≠p, b·∫°n c√≥ th·ªÉ d√πng supabaseUser.from(...) ƒë·ªÉ truy v·∫•n
    }
  };
</script>

</body>
</html>
