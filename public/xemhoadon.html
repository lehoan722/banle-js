<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Xem H√≥a ƒê∆°n B√°n L·∫ª</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    tr:hover {
      background-color: #f1f1f1;
      cursor: pointer;
    }

    input,
    select {
      margin: 4px;
      padding: 6px;
    }

    #popup {
      display: none;
      position: fixed;
      top: 10%;
      left: 10%;
      width: 80%;
      height: 70%;
      background: #fff;
      border: 1px solid #888;
      overflow: auto;
      padding: 20px;
      z-index: 9999;
    }
  </style>
</head>

<body>
  <h2>üìã Tra c·ª©u H√≥a ƒê∆°n B√°n L·∫ª</h2>


  <label>T·ª´ ng√†y: <input type="date" id="tuNgay"></label>
  <label>ƒê·∫øn ng√†y: <input type="date" id="denNgay"></label>
  <label>Nh√¢n vi√™n: <input type="text" id="locNV"></label>
  <label>Kh√°ch h√†ng: <input type="text" id="locKhach"></label>
  <label>Ti·ªÅn t·ª´: <input type="number" id="tienTu" style="width:80px"></label>
  <label>Ti·ªÅn ƒë·∫øn: <input type="number" id="tienDen" style="width:80px"></label>
  <label>S·ªë Hƒê: <input type="text" id="locSoHD"></label>

  <label>Lo·∫°i ch·ª©ng t·ª´:</label>
  <select id="loaiChungTu" multiple style="min-width:140px;">
    <option value="bancs1">bancs1</option>
    <option value="bancs2">bancs2</option>
    <option value="nmcs1">nmcs1</option>
    <option value="nmcs2">nmcs2</option>
    <option value="ccn1v2">ccn1v2</option>
    <option value="ccn2v1">ccn2v1</option>
  </select>

  <label>
    Xem t·ªïng h·ª£p:
    <select id="loaiTongHop" style="min-width:120px">
      <option value="chitiet">Chi ti·∫øt t·ª´ng h√≥a ƒë∆°n</option>
      <option value="ngay">T·ªïng h·ª£p theo ng√†y</option>
      <option value="thang">T·ªïng h·ª£p theo th√°ng</option>
      <option value="nam">T·ªïng h·ª£p theo nƒÉm</option>
    </select>
  </label>



  <button onclick="taiDanhSachHoaDon()">üîç L·ªçc</button>
  <button onclick="xoaHoaDonDaChon()">‚ùå X√≥a h√≥a ƒë∆°n ƒë√£ ch·ªçn</button>

  <table>
    <thead>
      <thead>
        <tr>
          <th>‚úîÔ∏è</th>
          <th>S·ªë Hƒê</th>
          <th>Ng√†y</th>
          <th>NV</th>
          <th>Kh√°ch</th>
          <th>T·ªïng SL</th>
          <th>TT</th>
          <th>Ghi ch√∫</th>
        </tr>
      </thead>

    </thead>
    <tbody id="dsHoaDon"></tbody>
  </table>


  <div id="popup">
    <h3>Chi ti·∫øt h√≥a ƒë∆°n: <span id="sohdCT"></span></h3>
    <table>
      <thead>
        <tr>
          <th>M√£ SP</th>
          <th>T√™n SP</th>
          <th>Size</th>
          <th>SL</th>
          <th>Gi√°</th>
          <th>KM</th>
          <th>Th√†nh ti·ªÅn</th>
        </tr>
      </thead>
      <tbody id="ctHoaDon"></tbody>
    </table>
    <button onclick="dongPopup()">ƒê√≥ng</button>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://rddjrmbyftlcvrgzlyby.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkZGpybWJ5ZnRsY3ZyZ3pseWJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NjU4MDQsImV4cCI6MjA2MjM0MTgwNH0.-0xtqxn6b9OBz4unTTvJ4klxizWhHa1iSuYGm7cOYTM'
    );

    async function taiDanhSachHoaDon() {
      // 1. L·∫•y c√°c gi√° tr·ªã l·ªçc t·ª´ giao di·ªán
      const tuNgay = document.getElementById("tuNgay").value;
      let denNgay = document.getElementById("denNgay").value;
      if (denNgay) denNgay = denNgay + "T23:59:59.999"; // Th√™m cu·ªëi ng√†y cho ƒë·∫øn ng√†y

      const nv = document.getElementById("locNV").value.trim().toUpperCase();
      const sohd = document.getElementById("locSoHD").value.trim();
      const khach = document.getElementById("locKhach").value.trim();
      const tienTu = Number(document.getElementById("tienTu").value);
      const tienDen = Number(document.getElementById("tienDen").value);

      const selectLoai = document.getElementById("loaiChungTu");
      const loaiChungTuArr = Array.from(selectLoai.selectedOptions).map(o => o.value);

      // L·∫•y gi√° tr·ªã t·ªïng h·ª£p
      const loaiTongHop = document.getElementById("loaiTongHop")?.value || "chitiet";

      // 2. T·∫°o truy v·∫•n Supabase
      let query = supabase
        .from('hoadon_banle')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(100);

      if (tuNgay && denNgay) query = query.gte('created_at', tuNgay).lte('created_at', denNgay);
      else if (tuNgay) query = query.gte('created_at', tuNgay);
      else if (denNgay) query = query.lte('created_at', denNgay);

      if (nv) query = query.ilike('tennv', `%${nv}%`);
      if (sohd) query = query.ilike('sohd', `%${sohd}%`);
      if (khach) query = query.ilike('khachhang', `%${khach}%`);
      if (!isNaN(tienTu) && tienTu > 0) query = query.gte('thanhtoan', tienTu);
      if (!isNaN(tienDen) && tienDen > 0) query = query.lte('thanhtoan', tienDen);

      // 3. Nh·∫≠n d·ªØ li·ªáu
      const { data, error } = await query;
      const tbody = document.getElementById("dsHoaDon");
      tbody.innerHTML = "";

      if (error) return alert("‚ùå L·ªói t·∫£i h√≥a ƒë∆°n: " + error.message);
      if (!data.length) return tbody.innerHTML = `<tr><td colspan="8">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;

      // 4. L·ªçc theo lo·∫°i ch·ª©ng t·ª´ (n·∫øu ng∆∞·ªùi d√πng c√≥ ch·ªçn)
      let filtered = data;
      if (loaiChungTuArr.length > 0) {
        filtered = data.filter(hd => {
          const loai = hd.sohd.split("_")[0];
          return loaiChungTuArr.includes(loai);
        });
      }

      // 5. X·ª≠ l√Ω t·ªïng h·ª£p n·∫øu kh√¥ng ph·∫£i chi ti·∫øt
      let hienThiData = filtered;
      if (loaiTongHop !== "chitiet") {
        const groupMap = new Map();
        filtered.forEach(hd => {
          // Key nh√≥m
          const d = new Date(hd.created_at);
          let key = "";
          if (loaiTongHop === "ngay") key = d.toISOString().slice(0, 10);
          if (loaiTongHop === "thang") key = d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0");
          if (loaiTongHop === "nam") key = d.getFullYear() + "";
          if (!groupMap.has(key)) {
            groupMap.set(key, {
              sohd: 1,
              created_at: hd.created_at,
              tongsl: Number(hd.tongsl || 0),
              thanhtoan: Number(hd.thanhtoan || 0)
            });
          } else {
            let obj = groupMap.get(key);
            obj.sohd += 1;
            obj.tongsl += Number(hd.tongsl || 0);
            obj.thanhtoan += Number(hd.thanhtoan || 0);
          }
        });
        hienThiData = Array.from(groupMap.entries()).map(([key, val]) => {
          // ƒê·ªãnh d·∫°ng l·∫°i ng√†y/th√°ng/nƒÉm ƒë·ªÉ hi·ªÉn th·ªã
          if (loaiTongHop === "ngay") val.created_at = key.split('-').reverse().join('/');
          if (loaiTongHop === "thang") val.created_at = key.slice(5, 7) + "/" + key.slice(0, 4);
          if (loaiTongHop === "nam") val.created_at = key;
          return val;
        });
      }

      // 6. H√†m ƒë·ªãnh d·∫°ng ng√†y gi·ªù c≈©
      function dinhDangNgayGio(ngayStr) {
        if (!ngayStr) return "";
        // N·∫øu chu·ªói c√≥ d·∫°ng dd/mm/yyyy th√¨ gi·ªØ nguy√™n
        if (ngayStr.match(/^\d{2}\/\d{2}\/\d{4}$/) || ngayStr.match(/^\d{2}\/\d{4}$/) || ngayStr.length === 4) return ngayStr;
        const d = new Date(ngayStr);
        const ngay = d.getDate().toString().padStart(2, "0");
        const thang = (d.getMonth() + 1).toString().padStart(2, "0");
        const nam = d.getFullYear();
        const gio = d.getHours().toString().padStart(2, "0");
        const phut = d.getMinutes().toString().padStart(2, "0");
        return `${ngay}/${thang}/${nam} ${gio}h${phut}`;
      }

      // 7. Hi·ªÉn th·ªã ra b·∫£ng
      hienThiData.forEach(hd => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
      <td></td>
      <td>${hd.sohd || hd.sohd}</td>
      <td>${dinhDangNgayGio(hd.created_at)}</td>
      <td></td>
      <td></td>
      <td>${hd.tongsl || 0}</td>
      <td>${hd.thanhtoan?.toLocaleString()}</td>
      <td></td>
    `;
        tr.onclick = (e) => {
          if (e.target.tagName !== 'INPUT' && loaiTongHop === "chitiet") xemChiTiet(hd.sohd);
        };
        tbody.appendChild(tr);
      });

      // 8. Th√™m d√≤ng t·ªïng cu·ªëi b·∫£ng
      let tongSL = 0, tongTien = 0;
      hienThiData.forEach(hd => {
        tongSL += Number(hd.tongsl || 0);
        tongTien += Number(hd.thanhtoan || 0);
      });
      const trTong = document.createElement("tr");
      trTong.style.fontWeight = "bold";
      trTong.style.background = "#f8f8f8";
      trTong.innerHTML = `
    <td colspan="5" style="text-align:right">T·ªîNG</td>
    <td id="tongSoLuong">${tongSL.toLocaleString()}</td>
    <td id="tongTien">${tongTien.toLocaleString()}</td>
    <td></td>
  `;
      tbody.appendChild(trTong);
    }



    async function xemChiTiet(sohd) {
      document.getElementById("popup").style.display = "block";
      document.getElementById("sohdCT").textContent = sohd;
      const { data, error } = await supabase.from('ct_hoadon_banle').select('*').eq('sohd', sohd);
      const tbody = document.getElementById("ctHoaDon");
      tbody.innerHTML = "";
      if (error) return tbody.innerHTML = `<tr><td colspan='7'>L·ªói: ${error.message}</td></tr>`;
      data.forEach(row => {
        const tt = (row.gia - row.km) * row.soluong;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.masp}</td><td>${row.tensp}</td><td>${row.size}</td><td>${row.soluong}</td><td>${row.gia}</td><td>${row.km}</td><td>${tt.toLocaleString()}</td>`;
        tbody.appendChild(tr);
      });
    }

    function dongPopup() {
      document.getElementById("popup").style.display = "none";
    }

    async function xoaHoaDonDaChon() {
      const checkboxes = document.querySelectorAll(".chonHD:checked");
      const sohdList = Array.from(checkboxes).map(cb => cb.dataset.sohd);

      if (sohdList.length === 0) return alert("‚ùó Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt h√≥a ƒë∆°n c·∫ßn x√≥a.");

      if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${sohdList.length} h√≥a ƒë∆°n kh·ªèi h·ªá th·ªëng?`)) return;

      // X√≥a kh·ªèi ct_hoadon_banle tr∆∞·ªõc
      const { error: errCT } = await supabase.from('ct_hoadon_banle').delete().in('sohd', sohdList);
      if (errCT) {
        console.error("‚ùå L·ªói x√≥a chi ti·∫øt:", errCT.message);
        return alert("Kh√¥ng th·ªÉ x√≥a chi ti·∫øt h√≥a ƒë∆°n.");
      }

      // Sau ƒë√≥ x√≥a kh·ªèi hoadon_banle
      const { error: errHD } = await supabase.from('hoadon_banle').delete().in('sohd', sohdList);
      if (errHD) {
        console.error("‚ùå L·ªói x√≥a h√≥a ƒë∆°n:", errHD.message);
        return alert("Kh√¥ng th·ªÉ x√≥a h√≥a ƒë∆°n.");
      }

      alert(`‚úÖ ƒê√£ x√≥a ${sohdList.length} h√≥a ƒë∆°n.`);
      taiDanhSachHoaDon();
    }


    window.onload = function () {
      // Set ng√†y m·∫∑c ƒë·ªãnh l√† h√¥m nay
      const today = new Date().toISOString().slice(0, 10);
      document.getElementById('tuNgay').value = today;
      document.getElementById('denNgay').value = today;
      taiDanhSachHoaDon();
    };

    document.getElementById("loaiTongHop").onchange = taiDanhSachHoaDon;


  </script>
</body>

</html>
