<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Nhập Danh Mục Hàng Hóa</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/handsontable/10.0.0/handsontable.full.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handsontable/10.0.0/handsontable.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.min.js"></script>
  <script>
    const SUPABASE_URL = 'https://rddjrmbyftlcvrgzlyby.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkZGpybWJ5ZnRsY3ZyZ3pseWJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NjU4MDQsImV4cCI6MjA2MjM0MTgwNH0.-0xtqxn6b9OBz4unTTvJ4klxizWhHa1iSuYGm7cOYTM';

    // Hàm tạo Supabase client dùng token mới nhất mỗi lần gọi
    function getSupabaseClient() {
      const token = localStorage.getItem('supabase_access_token');
      return window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_KEY,
        token
          ? { global: { headers: { Authorization: `Bearer ${token}` } } }
          : {}
      );
    }
  </script>

  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }

    input,
    button {
      margin: 5px 8px 5px 0;
    }
  </style>
</head>

<body>

  <h2>📦 Cập nhật Danh Mục Hàng Hóa từ Excel/CSV</h2>

  <input type="file" id="fileInput" accept=".csv,.xlsx" />
  <button onclick="loadCSV()">📂 Đọc dữ liệu từ file</button>
  <button onclick="uploadToSupabase()">📤 Ghi vào Supabase</button>
  <button onclick="console.log(hot.getData()[0])">🧪 Xem dòng 1</button>
  <label for="modeSelect">Cách ghi dữ liệu:</label>
  <select id="modeSelect">
    <option value="">-- Chọn cách ghi dữ liệu --</option>
    <option value="overwrite">📝 Ghi đè tất cả</option>
    <option value="update">✏️ Chỉ cập nhật dữ liệu</option>
  </select>
  <button onclick="kiemTraTuSupabase()">🔍 Kiểm tra dữ liệu</button>
  <div id="loginModule" style="display:inline-block; margin-left:16px;">
    <input id="login-email" type="email" placeholder="Email Supabase" style="width:130px;margin-right:2px;">
    <input id="login-password" type="password" placeholder="Mật khẩu" style="width:110px;margin-right:2px;">
    <button id="login-submit" class="btn">Đăng nhập</button>
    <span id="login-status" style="margin-left:6px;font-size:12px;color:#ad3a2b"></span>
  </div>



  <div id="hot" style="margin-top:20px;"></div>
  <div id="preview" style="margin-top:20px;"></div>

  <script>
    const TABLE_NAME = 'dmhanghoa';

    const columns = [
      { data: 'quanlykichco', type: 'checkbox' },
      { data: 'masp', type: 'text' },
      { data: 'gianhap', type: 'numeric' },
      { data: 'giale', type: 'numeric' },
      { data: 'giasi', type: 'numeric' },
      { data: 'mangan', type: 'text' },
      { data: 'nhomhang', type: 'text' },
      { data: 'tensp', type: 'text' },
      { data: 'nhacc', type: 'text' },
      { data: 'chungloai', type: 'text' },
      { data: 'vitrikho1', type: 'text' },
      { data: 'vitrikho2', type: 'text' },

      { data: 'dvt', type: 'text' },
      { data: 'khuyenmai', type: 'text' },
      { data: 'nhapdau', type: 'date', dateFormat: 'YYYY-MM-DD', correctFormat: true },
      { data: 'ngaysua', type: 'date', dateFormat: 'YYYY-MM-DD', correctFormat: true }

    ];

    const hot = new Handsontable(document.getElementById('hot'), {
      data: Array.from({ length: 100 }, () => ({})),
      columns,
      colHeaders: columns.map(c => c.data),
      rowHeaders: true,
      minSpareRows: 1,
      width: '100%',
      height: 500,
      stretchH: 'all',
      licenseKey: 'non-commercial-and-evaluation'
    });

    function loadCSV() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return alert('Vui lòng chọn file CSV.');

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          const data = results.data.map(row => {
            const normalized = {};
            for (const key in row) {
              normalized[key.toLowerCase()] = row[key];
            }
            return normalized;
          });

          hot.loadData(data);
          console.log("🧪 Loaded:", data[0]);
        }
      });
    }


    function parseDate(val) {
      if (!val) return null;
      if (typeof val === 'string' && val.includes('/')) {
        const [d, m, y] = val.split('/');
        if (d && m && y) return `${y.padStart(4, '20')}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
      }
      const d = new Date(val);
      return isNaN(d.getTime()) ? null : d.toISOString().split("T")[0];
    }

    function cleanRowFull(row) {
      const fields = {
        masp: "text", tensp: "text", dvt: "text", chungloai: "text",
        giale: "numeric", giasi: "numeric", mangan: "text", nhomhang: "text",
        mausac: "text", gianhap: "numeric", nhacc: "text",
        quanlykichco: "boolean", nhapdau: "date", ngaysua: "date",
        vitrikho1: "text", vitrikho2: "text", vitrikho3: "text",
        khuyenmai: "text"
      };


      const cleaned = {};
      for (const key in fields) {
        let val = row[key];
        if (val === "" || val == null) {
          cleaned[key] = null;
          continue;
        }

        if (fields[key] === "numeric") {
          cleaned[key] = isNaN(Number(val)) ? null : Number(val);
        } else if (fields[key] === "boolean") {
          const v = val.toString().toLowerCase();
          cleaned[key] = (v === "true" || v === "1" || v === "x" || v === "yes");
        } else if (fields[key] === "date") {
          cleaned[key] = parseDate(val);
        } else {
          let textVal = val.toString();
          if (key === "masp") textVal = textVal.toUpperCase();
          cleaned[key] = textVal;
        }
      }
      return cleaned;
    }

    function cleanRowPartial(row) {
      const fields = {
        masp: "text", tensp: "text", dvt: "text", chungloai: "text",
        giale: "numeric", giasi: "numeric", mangan: "text", nhomhang: "text",
        mausac: "text", gianhap: "numeric", nhacc: "text",
        quanlykichco: "boolean", nhapdau: "date", ngaysua: "date",
        vitrikho1: "text", vitrikho2: "text", vitrikho3: "text",
        khuyenmai: "text"
      };


      const cleaned = {};
      for (const key in fields) {
        let val = row[key];
        if (val === "" || val == null || (typeof val === "string" && val.trim() === "")) continue;

        if (fields[key] === "numeric") {
          const num = Number(val);
          if (!isNaN(num)) cleaned[key] = num;
        } else if (fields[key] === "boolean") {
          const v = val.toString().toLowerCase();
          cleaned[key] = (v === "true" || v === "1" || v === "x" || v === "yes");
        } else if (fields[key] === "date") {
          const d = parseDate(val);
          if (d) cleaned[key] = d;
        } else {
          let textVal = val.toString();
          if (key === "masp") textVal = textVal.toUpperCase();
          cleaned[key] = textVal;
        }
      }
      return cleaned;
    }


    async function uploadToSupabase() {
      const rawData = hot.getData();
      const data = rawData.filter(r => r.masp && r.masp.toString().trim() !== "");

      if (data.length === 0) return alert("Không có dòng hợp lệ để ghi.");

      if (!confirm("Bạn có chắc muốn ghi dữ liệu này vào Supabase?")) return;

      let inserted = 0, updated = 0, failed = 0, errors = [];
      const batchSize = 1000;

      for (let i = 0; i < data.length; i += batchSize) {
        const mode = document.getElementById("modeSelect").value;
        if (!mode) return alert("❗ Vui lòng chọn cách ghi dữ liệu trước khi ghi.");

        let batch;
        if (mode === "update") {
          batch = data.slice(i, i + batchSize).map(cleanRowPartial);
        } else {
          batch = data.slice(i, i + batchSize).map(cleanRowFull);
        }


        if (!batch.length || !batch[0].masp) {
          console.error("❗ Dữ liệu không hợp lệ:", batch[0]);
          alert("❌ Lỗi dữ liệu: batch không có masp hoặc sai định dạng.");
          return;
        }

        console.log("📦 Gửi batch:", JSON.stringify(batch[0], null, 2));

        try {
          const res = await fetch(SUPABASE_URL + "/rest/v1/" + TABLE_NAME, {
            method: "POST",
            headers: {
              apikey: SUPABASE_KEY,
              Authorization: "Bearer " + SUPABASE_KEY,
              "Content-Type": "application/json",
              Prefer: "resolution=merge-duplicates,return=representation"
            },
            body: JSON.stringify(batch)
          });


          const result = await res.json();
          if (!res.ok) {
            const errText = JSON.stringify(result);
            failed += batch.length;
            errors.push(`❌ Batch ${i + 1}: ${errText}`);
          } else {
            result.forEach(r => {
              if (r.updated_at) updated++; else inserted++;
            });
          }
        } catch (e) {
          failed += batch.length;
          errors.push(`⚠️ Lỗi kết nối tại batch ${i + 1}: ${e.message}`);
        }
      }

      document.getElementById("preview").innerHTML = `
      <h3>Kết quả:</h3>
      <ul>
        <li>🆕 Thêm mới: ${inserted}</li>
        <li>♻️ Ghi đè: ${updated}</li>
        <li>❌ Lỗi: ${failed}</li>
      </ul>
      ${errors.length ? `<details><summary>Chi tiết lỗi</summary><pre>${errors.join('\n')}</pre></details>` : ""}
    `;
    }

    async function kiemTraTuSupabase() {
      const allData = hot.getData();
      const maspIndex = columns.findIndex(c => c.data === 'masp');
      if (maspIndex === -1) return alert("Không tìm thấy cột mã sản phẩm!");

      // 1. Lấy danh sách mã sản phẩm duy nhất, bỏ rỗng
      const maspList = Array.from(
        new Set(
          allData
            .map(row => row[maspIndex])
            .filter(m => m && typeof m === 'string' && m.trim() !== '')
            .map(m => m.trim().toUpperCase())
        )
      );

      if (maspList.length === 0) {
        return alert("Không có mã sản phẩm nào để kiểm tra.");
      }

      // 2. Truy vấn Supabase (chỉ lấy cột cần thiết)
      const fieldList = columns.map(c => c.data).join(", ");
      const supabase = getSupabaseClient();
      const { data: serverData, error } = await supabase
        .from(TABLE_NAME)
        .select(fieldList)
        .in('masp', maspList);

      if (error) {
        console.error("❌ Lỗi khi truy vấn Supabase:", error);
        return alert("Không thể lấy dữ liệu từ Supabase.");
      }

      // 3. Map lại dữ liệu mới theo từng dòng (giữ đúng kiểu object)
      const dataMap = {};
      serverData.forEach(item => dataMap[item.masp.toUpperCase()] = item);

      // Tạo array of objects với đủ key cho Handsontable
      const newData = allData.map((row) => {
        const masp = row[maspIndex];
        if (!masp) return { ...row }; // dòng trống, giữ nguyên

        const fresh = dataMap[masp.toUpperCase()];
        if (!fresh) return { ...row }; // Không có dữ liệu mới, giữ nguyên

        const obj = { ...row };
        columns.forEach(col => {
          if (col.data === 'masp') return;
          obj[col.data] = fresh[col.data] ?? null;
        });
        return obj;
      });

      // Đảm bảo luôn có dòng trống cuối
      if (!newData[newData.length - 1] || Object.values(newData[newData.length - 1]).some(x => x)) {
        newData.push({});
      }

      hot.loadData(newData);

      alert("✅ Đã cập nhật dữ liệu từ Supabase cho các mã sản phẩm.");
    }



  </script>

  <script type="module">
    // Đăng nhập thành công reload lại trang để các API dùng token mới

    import { renderLoginModule } from './scripts/loginSupabaseModule.js';

    const supabaseUrl = 'https://rddjrmbyftlcvrgzlyby.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkZGpybWJ5ZnRsY3ZyZ3pseWJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NjU4MDQsImV4cCI6MjA2MjM0MTgwNH0.-0xtqxn6b9OBz4unTTvJ4klxizWhHa1iSuYGm7cOYTM';

    renderLoginModule({
      supabaseUrl,
      supabaseKey,
      onLoginSuccess: () => {
        window.location.reload(); // Đăng nhập thành công reload lại trang để các API dùng token mới
      }
    });
  </script>


</body>

</html>
<script async data-explicit-opt-in="true" data-cookie-opt-in="true"
  data-deployment-id="dpl_72h3v5BH1ss3PevUAaiq4t6ddMxx"
  src="https://vercel.live/_next-live/feedback/feedback.js"></script>
