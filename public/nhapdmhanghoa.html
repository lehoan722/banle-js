<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Nháº­p Danh Má»¥c HÃ ng HÃ³a</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/handsontable/10.0.0/handsontable.full.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handsontable/10.0.0/handsontable.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.min.js"></script>
  <script>
    const SUPABASE_URL = 'https://rddjrmbyftlcvrgzlyby.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkZGpybWJ5ZnRsY3ZyZ3pseWJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NjU4MDQsImV4cCI6MjA2MjM0MTgwNH0.-0xtqxn6b9OBz4unTTvJ4klxizWhHa1iSuYGm7cOYTM';

    // HÃ m táº¡o Supabase client dÃ¹ng token má»›i nháº¥t má»—i láº§n gá»i
    function getSupabaseClient() {
      const token = localStorage.getItem('supabase_access_token');
      return window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_KEY,
        token
          ? { global: { headers: { Authorization: `Bearer ${token}` } } }
          : {}
      );
    }
  </script>

  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }

    input,
    button {
      margin: 5px 8px 5px 0;
    }
  </style>
</head>

<body>

  <h2>ğŸ“¦ Cáº­p nháº­t Danh Má»¥c HÃ ng HÃ³a tá»« Excel/CSV</h2>

  <input type="file" id="fileInput" accept=".csv,.xlsx" />
  <button onclick="loadCSV()">ğŸ“‚ Äá»c dá»¯ liá»‡u tá»« file</button>
  <button onclick="uploadToSupabase()">ğŸ“¤ Ghi vÃ o Supabase</button>
  <button onclick="console.log(hot.getData()[0])">ğŸ§ª Xem dÃ²ng 1</button>
  <label for="modeSelect">CÃ¡ch ghi dá»¯ liá»‡u:</label>
  <select id="modeSelect">
    <option value="">-- Chá»n cÃ¡ch ghi dá»¯ liá»‡u --</option>
    <option value="overwrite">ğŸ“ Ghi Ä‘Ã¨ táº¥t cáº£</option>
    <option value="update">âœï¸ Chá»‰ cáº­p nháº­t dá»¯ liá»‡u</option>
  </select>
  <button onclick="kiemTraTuSupabase()">ğŸ” Kiá»ƒm tra dá»¯ liá»‡u</button>
  <div id="loginModule" style="display:inline-block; margin-left:16px;">
    <input id="login-email" type="email" placeholder="Email Supabase" style="width:130px;margin-right:2px;">
    <input id="login-password" type="password" placeholder="Máº­t kháº©u" style="width:110px;margin-right:2px;">
    <button id="login-submit" class="btn">ÄÄƒng nháº­p</button>
    <span id="login-status" style="margin-left:6px;font-size:12px;color:#ad3a2b"></span>
  </div>



  <div id="hot" style="margin-top:20px;"></div>
  <div id="preview" style="margin-top:20px;"></div>

  <script>
    const TABLE_NAME = 'dmhanghoa';

    const columns = [
      { data: 'quanlykichco', type: 'checkbox' },
      { data: 'masp', type: 'text' },
      { data: 'gianhap', type: 'numeric' },
      { data: 'giale', type: 'numeric' },
      { data: 'giasi', type: 'numeric' },
      { data: 'mangan', type: 'text' },
      { data: 'nhomhang', type: 'text' },
      { data: 'tensp', type: 'text' },
      { data: 'nhacc', type: 'text' },
      { data: 'chungloai', type: 'text' },
      { data: 'vitrikho1', type: 'text' },
      { data: 'vitrikho2', type: 'text' },

      { data: 'dvt', type: 'text' },
      { data: 'khuyenmai', type: 'text' },
      { data: 'nhapdau', type: 'date', dateFormat: 'YYYY-MM-DD', correctFormat: true },
      { data: 'ngaysua', type: 'date', dateFormat: 'YYYY-MM-DD', correctFormat: true }

    ];

    const hot = new Handsontable(document.getElementById('hot'), {
      data: Array.from({ length: 100 }, () => ({})),
      columns,
      colHeaders: columns.map(c => c.data),
      rowHeaders: true,
      minSpareRows: 1,
      width: '100%',
      height: 500,
      stretchH: 'all',
      licenseKey: 'non-commercial-and-evaluation'
    });

    function loadCSV() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return alert('Vui lÃ²ng chá»n file CSV.');

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          const data = results.data.map(row => {
            const normalized = {};
            for (const key in row) {
              normalized[key.toLowerCase()] = row[key];
            }
            return normalized;
          });

          hot.loadData(data);
          console.log("ğŸ§ª Loaded:", data[0]);
        }
      });
    }


    function parseDate(val) {
      if (!val) return null;
      if (typeof val === 'string' && val.includes('/')) {
        const [d, m, y] = val.split('/');
        if (d && m && y) return `${y.padStart(4, '20')}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
      }
      const d = new Date(val);
      return isNaN(d.getTime()) ? null : d.toISOString().split("T")[0];
    }

    function cleanRowFull(row) {
      const fields = {
        masp: "text", tensp: "text", dvt: "text", chungloai: "text",
        giale: "numeric", giasi: "numeric", mangan: "text", nhomhang: "text",
        mausac: "text", gianhap: "numeric", nhacc: "text",
        quanlykichco: "boolean", nhapdau: "date", ngaysua: "date",
        vitrikho1: "text", vitrikho2: "text", vitrikho3: "text",
        khuyenmai: "text"
      };


      const cleaned = {};
      for (const key in fields) {
        let val = row[key];
        if (val === "" || val == null) {
          cleaned[key] = null;
          continue;
        }

        if (fields[key] === "numeric") {
          cleaned[key] = isNaN(Number(val)) ? null : Number(val);
        } else if (fields[key] === "boolean") {
          const v = val.toString().toLowerCase();
          cleaned[key] = (v === "true" || v === "1" || v === "x" || v === "yes");
        } else if (fields[key] === "date") {
          cleaned[key] = parseDate(val);
        } else {
          let textVal = val.toString();
          if (key === "masp") textVal = textVal.toUpperCase();
          cleaned[key] = textVal;
        }
      }
      return cleaned;
    }

    function cleanRowPartial(row) {
      const fields = {
        masp: "text", tensp: "text", dvt: "text", chungloai: "text",
        giale: "numeric", giasi: "numeric", mangan: "text", nhomhang: "text",
        mausac: "text", gianhap: "numeric", nhacc: "text",
        quanlykichco: "boolean", nhapdau: "date", ngaysua: "date",
        vitrikho1: "text", vitrikho2: "text", vitrikho3: "text",
        khuyenmai: "text"
      };


      const cleaned = {};
      for (const key in fields) {
        let val = row[key];
        if (val === "" || val == null || (typeof val === "string" && val.trim() === "")) continue;

        if (fields[key] === "numeric") {
          const num = Number(val);
          if (!isNaN(num)) cleaned[key] = num;
        } else if (fields[key] === "boolean") {
          const v = val.toString().toLowerCase();
          cleaned[key] = (v === "true" || v === "1" || v === "x" || v === "yes");
        } else if (fields[key] === "date") {
          const d = parseDate(val);
          if (d) cleaned[key] = d;
        } else {
          let textVal = val.toString();
          if (key === "masp") textVal = textVal.toUpperCase();
          cleaned[key] = textVal;
        }
      }
      return cleaned;
    }


    async function uploadToSupabase() {
      const rawData = hot.getData();
      const data = rawData.filter(r => r.masp && r.masp.toString().trim() !== "");

      if (data.length === 0) return alert("KhÃ´ng cÃ³ dÃ²ng há»£p lá»‡ Ä‘á»ƒ ghi.");

      if (!confirm("Báº¡n cÃ³ cháº¯c muá»‘n ghi dá»¯ liá»‡u nÃ y vÃ o Supabase?")) return;

      let inserted = 0, updated = 0, failed = 0, errors = [];
      const batchSize = 1000;

      for (let i = 0; i < data.length; i += batchSize) {
        const mode = document.getElementById("modeSelect").value;
        if (!mode) return alert("â— Vui lÃ²ng chá»n cÃ¡ch ghi dá»¯ liá»‡u trÆ°á»›c khi ghi.");

        let batch;
        if (mode === "update") {
          batch = data.slice(i, i + batchSize).map(cleanRowPartial);
        } else {
          batch = data.slice(i, i + batchSize).map(cleanRowFull);
        }


        if (!batch.length || !batch[0].masp) {
          console.error("â— Dá»¯ liá»‡u khÃ´ng há»£p lá»‡:", batch[0]);
          alert("âŒ Lá»—i dá»¯ liá»‡u: batch khÃ´ng cÃ³ masp hoáº·c sai Ä‘á»‹nh dáº¡ng.");
          return;
        }

        console.log("ğŸ“¦ Gá»­i batch:", JSON.stringify(batch[0], null, 2));

        try {
          const res = await fetch(SUPABASE_URL + "/rest/v1/" + TABLE_NAME, {
            method: "POST",
            headers: {
              apikey: SUPABASE_KEY,
              Authorization: "Bearer " + SUPABASE_KEY,
              "Content-Type": "application/json",
              Prefer: "resolution=merge-duplicates,return=representation"
            },
            body: JSON.stringify(batch)
          });


          const result = await res.json();
          if (!res.ok) {
            const errText = JSON.stringify(result);
            failed += batch.length;
            errors.push(`âŒ Batch ${i + 1}: ${errText}`);
          } else {
            result.forEach(r => {
              if (r.updated_at) updated++; else inserted++;
            });
          }
        } catch (e) {
          failed += batch.length;
          errors.push(`âš ï¸ Lá»—i káº¿t ná»‘i táº¡i batch ${i + 1}: ${e.message}`);
        }
      }

      document.getElementById("preview").innerHTML = `
      <h3>Káº¿t quáº£:</h3>
      <ul>
        <li>ğŸ†• ThÃªm má»›i: ${inserted}</li>
        <li>â™»ï¸ Ghi Ä‘Ã¨: ${updated}</li>
        <li>âŒ Lá»—i: ${failed}</li>
      </ul>
      ${errors.length ? `<details><summary>Chi tiáº¿t lá»—i</summary><pre>${errors.join('\n')}</pre></details>` : ""}
    `;
    }

    async function kiemTraTuSupabase() {
      const allData = hot.getData();
      const maspIndex = columns.findIndex(c => c.data === 'masp');
      if (maspIndex === -1) return alert("KhÃ´ng tÃ¬m tháº¥y cá»™t mÃ£ sáº£n pháº©m!");

      // 1. Láº¥y danh sÃ¡ch mÃ£ sáº£n pháº©m duy nháº¥t, bá» rá»—ng
      const maspList = Array.from(
        new Set(
          allData
            .map(row => row[maspIndex])
            .filter(m => m && typeof m === 'string' && m.trim() !== '')
            .map(m => m.trim().toUpperCase())
        )
      );

      if (maspList.length === 0) {
        return alert("KhÃ´ng cÃ³ mÃ£ sáº£n pháº©m nÃ o Ä‘á»ƒ kiá»ƒm tra.");
      }

      // 2. Truy váº¥n Supabase (chá»‰ láº¥y cá»™t cáº§n thiáº¿t)
      const fieldList = columns.map(c => c.data).join(", ");
      const supabase = getSupabaseClient();
      const { data: serverData, error } = await supabase
        .from(TABLE_NAME)
        .select(fieldList)
        .in('masp', maspList);

      if (error) {
        console.error("âŒ Lá»—i khi truy váº¥n Supabase:", error);
        return alert("KhÃ´ng thá»ƒ láº¥y dá»¯ liá»‡u tá»« Supabase.");
      }

      // 3. Map láº¡i dá»¯ liá»‡u má»›i theo tá»«ng dÃ²ng (giá»¯ Ä‘Ãºng kiá»ƒu object)
      const dataMap = {};
      serverData.forEach(item => dataMap[item.masp.toUpperCase()] = item);

      // Táº¡o array of objects vá»›i Ä‘á»§ key cho Handsontable
      const newData = allData.map((row) => {
        const masp = row[maspIndex];
        if (!masp) return { ...row }; // dÃ²ng trá»‘ng, giá»¯ nguyÃªn

        const fresh = dataMap[masp.toUpperCase()];
        if (!fresh) return { ...row }; // KhÃ´ng cÃ³ dá»¯ liá»‡u má»›i, giá»¯ nguyÃªn

        const obj = { ...row };
        columns.forEach(col => {
          if (col.data === 'masp') return;
          obj[col.data] = fresh[col.data] ?? null;
        });
        return obj;
      });

      // Äáº£m báº£o luÃ´n cÃ³ dÃ²ng trá»‘ng cuá»‘i
      if (!newData[newData.length - 1] || Object.values(newData[newData.length - 1]).some(x => x)) {
        newData.push({});
      }

      hot.loadData(newData);

      alert("âœ… ÄÃ£ cáº­p nháº­t dá»¯ liá»‡u tá»« Supabase cho cÃ¡c mÃ£ sáº£n pháº©m.");
    }



  </script>

  <script type="module">
    // ÄÄƒng nháº­p thÃ nh cÃ´ng reload láº¡i trang Ä‘á»ƒ cÃ¡c API dÃ¹ng token má»›i

    import { renderLoginModule } from './scripts/loginSupabaseModule.js';

    const supabaseUrl = 'https://rddjrmbyftlcvrgzlyby.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkZGpybWJ5ZnRsY3ZyZ3pseWJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NjU4MDQsImV4cCI6MjA2MjM0MTgwNH0.-0xtqxn6b9OBz4unTTvJ4klxizWhHa1iSuYGm7cOYTM';

    renderLoginModule({
      supabaseUrl,
      supabaseKey,
      onLoginSuccess: () => {
        window.location.reload(); // ÄÄƒng nháº­p thÃ nh cÃ´ng reload láº¡i trang Ä‘á»ƒ cÃ¡c API dÃ¹ng token má»›i
      }
    });
  </script>


</body>

</html>
<script async data-explicit-opt-in="true" data-cookie-opt-in="true"
  data-deployment-id="dpl_72h3v5BH1ss3PevUAaiq4t6ddMxx"
  src="https://vercel.live/_next-live/feedback/feedback.js"></script>
